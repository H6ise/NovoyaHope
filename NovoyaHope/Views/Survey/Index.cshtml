@model IEnumerable<NovoyaHope.Models.Survey>

@{
    ViewData["Title"] = "Мои Опросы";
    Layout = "_Layout";
}

@section Styles {
    <link rel="stylesheet" href="~/css/surveys.css" asp-append-version="true" />
}

<div class="surveys-page">
    <div class="container">
        <!-- Page Header -->
        <div class="page-header">
            <div class="header-content">
                <h1 class="page-title">
                    <i class="fas fa-clipboard-list"></i>
                    Мои опросы
                </h1>
                <p class="page-subtitle">Управляйте своими опросами и анкетами</p>
            </div>
            <div class="header-actions">
                <a asp-action="Templates" class="btn-secondary-action">
                    <i class="fas fa-layer-group"></i>
                    Шаблоны
                </a>
                <a asp-action="Edit" class="btn-primary-action">
                    <i class="fas fa-plus"></i>
                    Создать опрос
                </a>
            </div>
        </div>

        <!-- Filters & Search -->
        <div class="toolbar">
            <div class="search-container">
                <i class="fas fa-search search-icon"></i>
                <input type="text" id="searchInput" class="search-input" placeholder="Поиск опросов...">
            </div>
            <div class="filter-buttons">
                <button class="filter-btn active" data-filter="all">
                    <i class="fas fa-th"></i> Все
                </button>
                <button class="filter-btn" data-filter="published">
                    <i class="fas fa-check-circle"></i> Опубликованные
                </button>
                <button class="filter-btn" data-filter="draft">
                    <i class="fas fa-file"></i> Черновики
                </button>
            </div>
            <select class="sort-select">
                <option value="date-desc">Сначала новые</option>
                <option value="date-asc">Сначала старые</option>
                <option value="title">По названию</option>
            </select>
        </div>

        <!-- Surveys Grid -->
        <div class="surveys-grid">
            <!-- Create New Card -->
            <a asp-action="Edit" class="survey-card card-create">
                <div class="card-icon-area">
                    <i class="fas fa-plus-circle"></i>
                </div>
                <div class="card-footer">
                    <h3 class="card-title">Создать новый опрос</h3>
                    <p class="card-subtitle">Начните с пустого шаблона</p>
                </div>
            </a>

            <!-- Survey Cards -->
            @foreach (var survey in Model)
            {
                <div class="survey-card" data-status="@(survey.IsPublished ? "published" : "draft")" data-title="@survey.Title">
                    <div class="card-header-bar @(survey.IsPublished ? "published" : "draft")">
                        @if (survey.IsPublished)
                        {
                            <span class="status-badge published">
                                <i class="fas fa-check-circle"></i> Опубликован
                            </span>
                        }
                        else
                        {
                            <span class="status-badge draft">
                                <i class="fas fa-edit"></i> Черновик
                            </span>
                        }
                        <div class="card-menu">
                            <button class="menu-btn" onclick="toggleMenu(event, @survey.Id)">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                            <div class="dropdown-menu" id="menu-@survey.Id">
                                <a asp-action="Edit" asp-route-id="@survey.Id" class="dropdown-item">
                                    <i class="fas fa-edit"></i> Редактировать
                                </a>
                                @if (survey.IsPublished)
                                {
                                    <a asp-action="Results" asp-route-id="@survey.Id" class="dropdown-item">
                                        <i class="fas fa-chart-bar"></i> Результаты
                                    </a>
                                    <a asp-controller="Public" asp-action="ViewSurvey" asp-route-id="@survey.Id" target="_blank" class="dropdown-item">
                                        <i class="fas fa-external-link-alt"></i> Открыть
                                    </a>
                                    <button onclick="copySurveyLink(@survey.Id)" class="dropdown-item">
                                        <i class="fas fa-link"></i> Копировать ссылку
                                    </button>
                                }
                                <div class="dropdown-divider"></div>
                                <a href="#" class="dropdown-item text-danger">
                                    <i class="fas fa-trash"></i> Удалить
                                </a>
                            </div>
                        </div>
                    </div>
                    
                    <a asp-action="Edit" asp-route-id="@survey.Id" class="card-content">
                        <div class="card-icon-preview">
                            <i class="fas fa-poll"></i>
                        </div>
                        <h3 class="card-title">
                            @(string.IsNullOrEmpty(survey.Title) ? "Без названия" : survey.Title)
                        </h3>
                        @if (!string.IsNullOrEmpty(survey.Description))
                        {
                            <p class="card-description">@survey.Description</p>
                        }
                    </a>
                    
                    <div class="card-footer">
                        <div class="card-info">
                            <span class="info-item">
                                <i class="fas fa-calendar"></i>
                                @survey.CreatedDate.ToString("dd MMM yyyy")
                            </span>
                            @if (survey.IsPublished)
                            {
                                <span class="info-item">
                                    <i class="fas fa-users"></i>
                                    0 ответов
                                </span>
                            }
                        </div>
                        <div class="card-actions">
                            @if (survey.IsPublished)
                            {
                                <a asp-action="Results" asp-route-id="@survey.Id" class="action-btn" title="Результаты">
                                    <i class="fas fa-chart-line"></i>
                                </a>
                            }
                            <a asp-action="Edit" asp-route-id="@survey.Id" class="action-btn" title="Редактировать">
                                <i class="fas fa-edit"></i>
                            </a>
                        </div>
                    </div>
                </div>
            }
        </div>

        <!-- Empty State -->
        @if (!Model.Any())
        {
            <div class="empty-state">
                <i class="fas fa-clipboard-list"></i>
                <h3>У вас пока нет опросов</h3>
                <p>Создайте свой первый опрос или выберите готовый шаблон</p>
                <div class="empty-actions">
                    <a asp-action="Edit" class="btn-primary-action">
                        <i class="fas fa-plus"></i>
                        Создать опрос
                    </a>
                    <a asp-action="Templates" class="btn-secondary-action">
                        <i class="fas fa-layer-group"></i>
                        Шаблоны
                    </a>
                </div>
            </div>
        }
    </div>
</div>

@section Scripts {
    <script>
        // Search functionality
        document.getElementById('searchInput')?.addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            document.querySelectorAll('.survey-card[data-title]').forEach(card => {
                const title = card.getAttribute('data-title').toLowerCase();
                card.style.display = title.includes(searchTerm) ? '' : 'none';
            });
        });

        // Filter functionality
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                
                const filter = this.getAttribute('data-filter');
                document.querySelectorAll('.survey-card[data-status]').forEach(card => {
                    const status = card.getAttribute('data-status');
                    card.style.display = (filter === 'all' || filter === status) ? '' : 'none';
                });
            });
        });

        // Menu toggle
        function toggleMenu(event, id) {
            event.preventDefault();
            event.stopPropagation();
            const menu = document.getElementById('menu-' + id);
            document.querySelectorAll('.dropdown-menu').forEach(m => {
                if (m !== menu) m.classList.remove('show');
            });
            menu.classList.toggle('show');
        }

        // Close menus on outside click
        document.addEventListener('click', function() {
            document.querySelectorAll('.dropdown-menu').forEach(menu => {
                menu.classList.remove('show');
            });
        });

        // Copy survey link
        function copySurveyLink(id) {
            const link = window.location.origin + '/Public/ViewSurvey/' + id;
            navigator.clipboard.writeText(link).then(() => {
                if (typeof showToast === 'function') {
                    showToast('Ссылка скопирована!', 'success');
                } else {
                    alert('Ссылка скопирована: ' + link);
                }
            });
        }
    </script>
}