@model NovoyaHope.Models.ViewModels.SurveyConstructorViewModel
@using NovoyaHope.Models

@{
    ViewData["Title"] = "Конструктор - " + (Model.Survey.Title ?? "Новая форма");
    Layout = "_Layout";
}

@section Styles {
    <link rel="stylesheet" href="~/css/constructor.css" asp-append-version="true" />
}

<body data-survey-id="@Model.Survey.Id">

    <form asp-controller="Survey" asp-action="Save" method="post" id="survey-form">
        @Html.AntiForgeryToken()
        <input type="hidden" name="Survey.Id" value="@Model.Survey.Id" />
        <input type="hidden" name="Survey.IsPublished" value="@Model.Survey.IsPublished.ToString()" />

        <div class="editor-header">
            <div class="editor-header-inner">

                <div class="header-left">
                    <i class="fas fa-eye header-icon" title="Предпросмотр"></i>
                    <i class="fas fa-palette header-icon" title="Настроить тему"></i>
                    <i class="fas fa-cog header-icon" title="Настройки"></i>
                </div>

                <div class="tabs-nav">
                    <a href="#" class="tab-link active" onclick="switchTab(event, 'questions')">Вопросы</a>
                    <a asp-controller="Response" asp-action="Index" asp-route-surveyId="@Model.Survey.Id" class="tab-link">Ответы</a>
                    <a href="#" class="tab-link" onclick="switchTab(event, 'settings')">Настройки</a>
                </div>

                <div class="header-right">
                    <button type="button" onclick="saveSurvey()" class="btn-secondary" style="margin-right: 10px;">Сохранить</button>
                    @if (Model.Survey.IsPublished)
                    {
                        <a asp-controller="Public" asp-action="ViewSurvey" asp-route-id="@Model.Survey.Id" target="_blank" 
                           class="btn-secondary" style="margin-right: 10px; text-decoration: none; display: inline-block;">🔗 Открыть</a>
                        <a asp-action="Results" asp-route-id="@Model.Survey.Id" 
                           class="btn-secondary" style="margin-right: 10px; text-decoration: none; display: inline-block;">📊 Результаты</a>
                        <button type="button" onclick="unpublishSurvey(@Model.Survey.Id)" class="btn-secondary" style="background-color: #f5faf5; color: #2e7d32;">
                            Снять с публикации
                        </button>
                    }
                    else
                    {
                        <button type="button" onclick="publishSurvey(@Model.Survey.Id)" class="btn-primary" style="background-color: #2e7d32;">
                            Опубликовать
                        </button>
                    }
                </div>
            </div>
        </div>

        <div class="editor-main">

            <div id="tab-questions" class="tab-content active" style="width: 100%; display: flex; justify-content: center;">

                <div class="questions-container" id="questions-container">

                    <div class="question-block active" style="border-left: 7px solid var(--primary-color);">
                        <input type="text" id="survey-title-input" class="editor-title-input"
                               value="@(Model.Survey.Title ?? "Новая форма")" placeholder="Новая форма"
                               name="Survey.Title">

                        <input type="text" id="survey-description-input" class="question-input"
                               value="@Model.Survey.Description" placeholder="Описание"
                               name="Survey.Description">
                    </div>

                    @if (Model.Questions != null)
                    {
                        foreach (var question in Model.Questions.OrderBy(q => q.Order))
                        {
                            // Рендеринг сохраненного вопроса (упрощенный пример)
                            <div class="question-block" data-question-id="@question.Id">
                                <div class="question-header">
                                    <input type="text" class="question-input question-text-input"
                                           placeholder="Вопрос без заголовка"
                                           value="@question.Text"
                                           name="Questions[@question.Id].Text">

                                    <select class="form-control question-type-select"
                                            name="Questions[@question.Id].Type"
                                            data-question-id="@question.Id"
                                            onchange="changeQuestionType(this, @question.Id)">
                                        <option value="SingleChoice" selected="@(question.Type == QuestionType.SingleChoice)">Один из списка</option>
                                        <option value="MultipleChoice" selected="@(question.Type == QuestionType.MultipleChoice)">Несколько из списка</option>
                                        <option value="Dropdown" selected="@(question.Type == QuestionType.Dropdown)">Раскрывающийся список</option>
                                        <option value="ShortText" selected="@(question.Type == QuestionType.ShortText)">Текст (строка)</option>
                                        <option value="ParagraphText" selected="@(question.Type == QuestionType.ParagraphText)">Текст (абзац)</option>
                                        <option value="FileUpload" selected="@(question.Type == QuestionType.FileUpload)">Загрузка файлов</option>
                                        <option value="Scale" selected="@(question.Type == QuestionType.Scale)">Шкала</option>
                                        <option value="Rating" selected="@(question.Type == QuestionType.Rating)">Оценка ⭐</option>
                                        <option value="CheckboxGrid" selected="@(question.Type == QuestionType.CheckboxGrid)">Сетка (множественный выбор)</option>
                                        <option value="RadioGrid" selected="@(question.Type == QuestionType.RadioGrid)">Сетка флажков</option>
                                        <option value="Date" selected="@(question.Type == QuestionType.Date)">Дата</option>
                                        <option value="Time" selected="@(question.Type == QuestionType.Time)">Время</option>
                                    </select>
                                </div>
                                <div class="question-body options-container" data-question-id="@question.Id">
                                    @if (question.Options != null && question.Options.Any())
                                    {
                                        foreach (var option in question.Options.OrderBy(o => o.Order))
                                        {
                                            <div class="option-item" data-option-id="@option.Id">
                                                <input type="@(question.Type == QuestionType.MultipleChoice ? "checkbox" : "radio")" disabled style="margin-right: 10px;">
                                                <input type="text" class="option-input"
                                                       value="@option.Text"
                                                       name="Questions[@question.Id].Options[@option.Id].Text">
                                                <input type="hidden" name="Questions[@question.Id].Options[@option.Id].Order" value="@option.Order">
                                                <button type="button" class="btn-icon delete-option-btn" onclick="deleteOption(this)">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </div>
                                        }
                                    }
                                    <div class="add-option-area" onclick="addOptionToQuestion(@question.Id)">
                                        <input type="@(question.Type == QuestionType.MultipleChoice ? "checkbox" : "radio")" disabled style="margin-right: 10px;">
                                        <span class="add-option-link">Добавить вариант</span>
                                    </div>
                                </div>
                                <div class="question-footer">
                                    <button type="button" class="btn-icon duplicate-btn" title="Дублировать" onclick="duplicateQuestion(this)"><i class="far fa-copy"></i></button>
                                    <button type="button" class="btn-icon delete-btn" title="Удалить" onclick="deleteQuestion(this)"><i class="fas fa-trash-alt"></i></button>
                                    <div class="separator-line"></div>
                                    <label class="required-label">
                                        Обязательный вопрос
                                        <input type="checkbox" class="required-toggle" name="Questions[@question.Id].IsRequired" @(question.IsRequired ? "checked" : "")>
                                    </label>
                                </div>
                            </div>
                        }
                    }

                    <input type="hidden" id="deleted-elements" name="DeletedElements" value="" />

                </div>
            </div>

            <!-- Летающий Бар (FAB - Floating Action Bar) -->
            <div class="fab-container">
                <div class="fab-menu" id="fab-menu">
                    <div class="fab-item" onclick="addNewQuestion()">
                        <span class="fab-label">Добавить вопрос</span>
                        <button type="button" class="fab-action" title="Добавить вопрос">
                            ➕
                        </button>
                    </div>
                    <div class="fab-item" onclick="addSection()">
                        <span class="fab-label">Добавить раздел</span>
                        <button type="button" class="fab-action" title="Добавить раздел">
                            📑
                        </button>
                    </div>
                    <div class="fab-item" onclick="addImage()">
                        <span class="fab-label">Добавить фото</span>
                        <button type="button" class="fab-action" title="Добавить фото">
                            🖼️
                        </button>
                    </div>
                    <div class="fab-item" onclick="addVideo()">
                        <span class="fab-label">Добавить видео</span>
                        <button type="button" class="fab-action" title="Добавить видео">
                            🎬
                        </button>
                    </div>
                    <div class="fab-item" onclick="addTextBlock()">
                        <span class="fab-label">Добавить текст</span>
                        <button type="button" class="fab-action" title="Добавить текстовый блок">
                            📝
                        </button>
                    </div>
                </div>
                <button type="button" class="fab-main" id="fab-main" onclick="toggleFabMenu()">
                    ➕
                </button>
            </div>
        </div>

            <div id="tab-settings" class="tab-content" style="display: none;">
                <div style="max-width: 600px; margin: 40px auto; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);">
                    <h3>Настройки формы</h3>
                    <p style="color: var(--gray-text);">Здесь будет интерфейс для управления общими настройками опроса: ограничение на один ответ, показ шкалы прогресса и т.д.</p>
                </div>
            </div>

        </div>
    </form>

    @section Scripts {
        <script>
            // Показываем сообщения из TempData, если они есть
            @if (TempData["SuccessMessage"] != null)
            {
                <text>
                alert('@Html.Raw(TempData["SuccessMessage"])');
                </text>
            }
            @if (TempData["ErrorMessage"] != null)
            {
                <text>
                alert('@Html.Raw(TempData["ErrorMessage"])');
                </text>
            }

            // JS-функция для переключения вкладок
            function switchTab(event, tabName) {
                event.preventDefault();
                document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
                document.querySelectorAll('.tab-link').forEach(el => el.classList.remove('active'));

                // Активируем нужную вкладку
                document.getElementById('tab-' + tabName).style.display = (tabName === 'questions' ? 'flex' : 'block');
                event.target.classList.add('active');
            }

            // JS-функция для сохранения опросника
            function saveSurvey() {
                // Собираем данные формы
                const formData = collectFormData();
                
                // Валидация данных перед отправкой
                if (!formData.Title || formData.Title.trim() === '') {
                    showSaveMessage('Ошибка: укажите заголовок опроса', 'error');
                    return;
                }
                
                console.log('Отправляемые данные:', JSON.stringify(formData, null, 2));
                
                // Получаем токен из формы
                var token = document.querySelector('input[name="__RequestVerificationToken"]')?.value || '';
                
                // Если токен не найден в форме, пытаемся получить из cookie
                if (!token) {
                    var cookies = document.cookie.split(';');
                    for (var i = 0; i < cookies.length; i++) {
                        var cookie = cookies[i].trim();
                        if (cookie.startsWith('__RequestVerificationToken=')) {
                            token = cookie.substring('__RequestVerificationToken='.length);
                            break;
                        }
                    }
                }
                
                if (!token) {
                    alert('Ошибка: не найден токен безопасности. Перезагрузите страницу и попробуйте снова.');
                    return;
                }

                // Показываем индикатор загрузки
                const saveButton = document.querySelector('button[onclick="saveSurvey()"]');
                const originalText = saveButton ? saveButton.textContent : 'Сохранить';
                if (saveButton) {
                    saveButton.disabled = true;
                    saveButton.textContent = 'Сохранение...';
                }

                // Отправляем данные через AJAX
                fetch('/api/surveys/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': token
                    },
                    credentials: 'include',
                    body: JSON.stringify(formData)
                })
                .then(async response => {
                    const contentType = response.headers.get('content-type');
                    console.log('Response status:', response.status, 'Content-Type:', contentType);
                    
                    if (contentType && contentType.includes('application/json')) {
                        const data = await response.json();
                        console.log('Response data:', data);
                        return { ok: response.ok, status: response.status, data: data };
                    } else {
                        const text = await response.text();
                        console.error('Non-JSON response:', text);
                        throw new Error(text || `Ошибка сохранения: ${response.status} ${response.statusText}`);
                    }
                })
                .then(result => {
                    if (result.ok && result.data.Success) {
                        // Показываем сообщение об успехе
                        showSaveMessage('Опросник успешно сохранен!', 'success');
                    } else {
                        // Обрабатываем ошибки валидации
                        let errorMessage = 'Ошибка при сохранении';
                        if (result.data && result.data.Message) {
                            errorMessage = result.data.Message;
                        } else if (result.data && result.data.Errors) {
                            // Пытаемся извлечь сообщения об ошибках из ModelState
                            const errors = [];
                            for (const key in result.data.Errors) {
                                if (result.data.Errors[key] && result.data.Errors[key].Errors) {
                                    result.data.Errors[key].Errors.forEach(err => {
                                        if (err.ErrorMessage) {
                                            errors.push(err.ErrorMessage);
                                        }
                                    });
                                }
                            }
                            if (errors.length > 0) {
                                errorMessage = errors.join('; ');
                            }
                        }
                        throw new Error(errorMessage);
                    }
                })
                .catch(error => {
                    console.error('Error details:', error);
                    console.error('Error stack:', error.stack);
                    const errorMessage = error.message || 'Неизвестная ошибка';
                    showSaveMessage('Ошибка при сохранении: ' + errorMessage, 'error');
                })
                .finally(() => {
                    // Восстанавливаем кнопку
                    if (saveButton) {
                        saveButton.disabled = false;
                        saveButton.textContent = originalText;
                    }
                });
            }

            // Функция для отображения сообщений о сохранении
            function showSaveMessage(message, type) {
                // Удаляем предыдущее сообщение, если есть
                const existingMessage = document.getElementById('save-message');
                if (existingMessage) {
                    existingMessage.remove();
                }

                // Создаем новое сообщение
                const messageDiv = document.createElement('div');
                messageDiv.id = 'save-message';
                messageDiv.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 15px 20px;
                    background-color: ${type === 'success' ? '#4caf50' : '#f44336'};
                    color: white;
                    border-radius: 4px;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
                    z-index: 10000;
                    font-size: 14px;
                    max-width: 300px;
                    animation: slideIn 0.3s ease-out;
                `;
                messageDiv.textContent = message;

                // Добавляем анимацию
                const style = document.createElement('style');
                style.textContent = `
                    @@keyframes slideIn {
                        from {
                            transform: translateX(100%);
                            opacity: 0;
                        }
                        to {
                            transform: translateX(0);
                            opacity: 1;
                        }
                    }
                    @@keyframes slideOut {
                        from {
                            transform: translateX(0);
                            opacity: 1;
                        }
                        to {
                            transform: translateX(100%);
                            opacity: 0;
                        }
                    }
                `;
                if (!document.querySelector('style[data-save-message]')) {
                    style.setAttribute('data-save-message', 'true');
                    document.head.appendChild(style);
                }

                document.body.appendChild(messageDiv);

                // Автоматически удаляем сообщение через 3 секунды
                setTimeout(() => {
                    messageDiv.style.animation = 'slideOut 0.3s ease-out';
                    setTimeout(() => {
                        if (messageDiv.parentNode) {
                            messageDiv.remove();
                        }
                    }, 300);
                }, 3000);
            }

            // Функция для сбора данных формы и преобразования в JSON
            function collectFormData() {
                const form = document.getElementById('survey-form');
                const formData = new FormData(form);
                const surveyId = parseInt(form.querySelector('input[name="Survey.Id"]')?.value || '0');
                
                const data = {
                    Id: surveyId || null,
                    Title: form.querySelector('#survey-title-input')?.value || '',
                    Description: form.querySelector('#survey-description-input')?.value || '',
                    Type: 'Questionnaire', // Используем строковое значение enum
                    IsPublished: false,
                    IsAnonymous: true,
                    Questions: []
                };
                
                // Собираем вопросы
                const questionBlocks = document.querySelectorAll('.question-block[data-question-id]');
                let questionOrder = 0;
                
                questionBlocks.forEach(block => {
                    const questionIdAttr = block.getAttribute('data-question-id');
                    const questionId = questionIdAttr && questionIdAttr.startsWith('-') ? null : parseInt(questionIdAttr);
                    const textInput = block.querySelector('.question-text-input');
                    const typeSelect = block.querySelector('.question-type-select');
                    const isRequired = block.querySelector('.required-toggle')?.checked || false;
                    
                    if (!textInput || !textInput.value.trim()) {
                        return; // Пропускаем вопросы без текста
                    }
                    
                    const questionType = typeSelect ? typeSelect.value : 'SingleChoice';
                    
                    const question = {
                        Id: questionId || null,
                        Order: questionOrder++,
                        Text: textInput.value.trim(),
                        Type: questionType, // ASP.NET Core автоматически преобразует строку в enum
                        IsRequired: isRequired,
                        Options: []
                    };
                    
                    // Собираем варианты ответов
                    const optionItems = block.querySelectorAll('.option-item[data-option-id]');
                    let optionOrder = 0;
                    
                    optionItems.forEach(optionItem => {
                        const optionIdAttr = optionItem.getAttribute('data-option-id');
                        const optionId = optionIdAttr && optionIdAttr.startsWith('-') ? null : parseInt(optionIdAttr);
                        const optionTextInput = optionItem.querySelector('.option-input');
                        
                        if (!optionTextInput || !optionTextInput.value.trim()) {
                            return; // Пропускаем пустые варианты
                        }
                        
                        question.Options.push({
                            Id: optionId || null,
                            Text: optionTextInput.value.trim(),
                            Order: optionOrder++
                        });
                    });
                    
                    // Добавляем вопрос только если у него есть варианты ответов (для типов с выбором)
                    // или если это текстовый вопрос
                    const needsOptions = ['SingleChoice', 'MultipleChoice', 'Dropdown', 'Scale', 'Rating'].includes(questionType);
                    if (!needsOptions || question.Options.length > 0) {
                        data.Questions.push(question);
                    }
                });
                
                return data;
            }
            
            // JS-функция для публикации
            function publishSurvey(surveyId) {
                if (confirm('Опубликовать эту форму? Она станет доступна по ссылке.')) {
                    // Сначала сохраняем данные формы
                    const formData = collectFormData();
                    
                    // Получаем токен из формы
                    var token = document.querySelector('input[name="__RequestVerificationToken"]')?.value || '';
                    
                    // Если токен не найден в форме, пытаемся получить из cookie
                    if (!token) {
                        var cookies = document.cookie.split(';');
                        for (var i = 0; i < cookies.length; i++) {
                            var cookie = cookies[i].trim();
                            if (cookie.startsWith('__RequestVerificationToken=')) {
                                token = cookie.substring('__RequestVerificationToken='.length);
                                break;
                            }
                        }
                    }
                    
                    if (!token) {
                        alert('Ошибка: не найден токен безопасности. Перезагрузите страницу и попробуйте снова.');
                        return;
                    }
                    
                    // Сохраняем данные перед публикацией
                    fetch('/api/surveys/save', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'RequestVerificationToken': token
                        },
                        credentials: 'include',
                        body: JSON.stringify(formData)
                    })
                    .then(async response => {
                        const contentType = response.headers.get('content-type');
                        if (contentType && contentType.includes('application/json')) {
                            const data = await response.json();
                            return { ok: response.ok, data: data };
                        } else {
                            const text = await response.text();
                            throw new Error(text || `Ошибка сохранения: ${response.status}`);
                        }
                    })
                    .then(saveResult => {
                        if (!saveResult.ok || !saveResult.data.Success) {
                            throw new Error(saveResult.data.Message || 'Ошибка при сохранении данных');
                        }
                        
                        // После успешного сохранения публикуем
                        return fetch(`/Survey/Publish/${surveyId}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                                'RequestVerificationToken': token
                            },
                            credentials: 'include',
                            body: '__RequestVerificationToken=' + encodeURIComponent(token)
                        });
                    })
                    .then(async response => {
                        const contentType = response.headers.get('content-type');
                        if (contentType && contentType.includes('application/json')) {
                            const data = await response.json();
                            return { ok: response.ok, status: response.status, data: data };
                        } else {
                            const text = await response.text();
                            console.error('Non-JSON response:', text);
                            return { ok: false, status: response.status, data: { success: false, message: `Ошибка ${response.status}: ${response.statusText}` } };
                        }
                    })
                    .then(result => {
                        if (result.ok && result.data.success) {
                            alert(result.data.message);
                            location.reload();
                        } else {
                            alert(result.data.message || 'Ошибка при публикации');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Ошибка при публикации опроса: ' + (error.message || 'Неизвестная ошибка'));
                    });
                }
            }

            // JS-функция для снятия с публикации
            function unpublishSurvey(surveyId) {
                if (confirm('Снять форму с публикации? Она больше не будет доступна по ссылке.')) {
                    // Получаем токен из формы
                    var token = document.querySelector('input[name="__RequestVerificationToken"]')?.value || '';
                    
                    // Если токен не найден в форме, пытаемся получить из cookie
                    if (!token) {
                        var cookies = document.cookie.split(';');
                        for (var i = 0; i < cookies.length; i++) {
                            var cookie = cookies[i].trim();
                            if (cookie.startsWith('__RequestVerificationToken=')) {
                                token = cookie.substring('__RequestVerificationToken='.length);
                                break;
                            }
                        }
                    }
                    
                    if (!token) {
                        alert('Ошибка: не найден токен безопасности. Перезагрузите страницу и попробуйте снова.');
                        return;
                    }
                    
                    fetch(`/Survey/Unpublish/${surveyId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'RequestVerificationToken': token
                        },
                        credentials: 'include', // Важно для отправки cookies
                        body: '__RequestVerificationToken=' + encodeURIComponent(token)
                    })
                    .then(async response => {
                        const contentType = response.headers.get('content-type');
                        if (contentType && contentType.includes('application/json')) {
                            const data = await response.json();
                            return { ok: response.ok, status: response.status, data: data };
                        } else {
                            const text = await response.text();
                            console.error('Non-JSON response:', text);
                            return { ok: false, status: response.status, data: { success: false, message: `Ошибка ${response.status}: ${response.statusText}` } };
                        }
                    })
                    .then(result => {
                        if (result.ok && result.data.success) {
                            alert(result.data.message);
                            location.reload();
                        } else {
                            alert(result.data.message || 'Ошибка при снятии с публикации');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Ошибка при снятии с публикации: ' + (error.message || 'Неизвестная ошибка'));
                    });
                }
            }
        </script>

        <script src="~/js/constructor.js" asp-append-version="true"></script>
    }
</body>