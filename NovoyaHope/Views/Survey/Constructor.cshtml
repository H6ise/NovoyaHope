@model NovoyaHope.Models.ViewModels.SurveyConstructorViewModel
@using NovoyaHope.Models

@{
    ViewData["Title"] = "Конструктор - " + (Model.Survey.Title ?? "Новая форма");
    Layout = "_Layout";
}

@section Styles {
    <link rel="stylesheet" href="~/css/constructor.css" asp-append-version="true" />
}

<body data-survey-id="@Model.Survey.Id">

    <form asp-controller="Survey" asp-action="Save" method="post" id="survey-form" enctype="multipart/form-data">
        @Html.AntiForgeryToken()
        <input type="hidden" name="Survey.Id" value="@Model.Survey.Id" />
        <input type="hidden" name="Survey.IsPublished" value="@Model.Survey.IsPublished.ToString()" />

        <div class="editor-header">
            <div class="editor-header-inner">

                <div class="header-left">
                    <i class="fas fa-eye header-icon" id="preview-icon" title="Предпросмотр" onclick="openPreview()"></i>
                    <i class="fas fa-palette header-icon" id="theme-toggle" title="Настроить тему" onclick="toggleThemePanel()"></i>                    
                    <div class="undo-redo-buttons">
                        <button type="button" class="header-icon-btn" id="undo-btn" title="Отменить (Ctrl+Z)" onclick="undoAction()" disabled>
                            <i class="fas fa-undo"></i>
                        </button>
                        <button type="button" class="header-icon-btn" id="redo-btn" title="Повторить (Ctrl+Y)" onclick="redoAction()" disabled>
                            <i class="fas fa-redo"></i>
                        </button>
                    </div>
                </div>

                <div class="tabs-nav">
                    <a href="#" class="tab-link active" onclick="switchTab(event, 'questions')">Вопросы</a>
                    <a href="#" class="tab-link" onclick="switchTab(event, 'answers')">Ответы</a>
                    <a href="#" class="tab-link" onclick="switchTab(event, 'settings')">Настройки</a>
                </div>

                <div class="header-right">
                    <button type="button" onclick="saveSurvey()" class="btn-secondary" style="margin-right: 10px;">Сохранить</button>
                    @if (Model.Survey.IsPublished)
                    {
                        <a asp-controller="Public" asp-action="ViewSurvey" asp-route-id="@Model.Survey.Id" target="_blank" 
                           class="btn-secondary" style="margin-right: 10px; text-decoration: none; display: inline-block;">🔗 Открыть</a>                        
                        <button type="button" onclick="unpublishSurvey(@Model.Survey.Id)" class="btn-secondary" style="background-color: #f5faf5; color: #2e7d32;">
                            Снять с публикации
                        </button>
                    }
                    else
                    {
                        <button type="button" onclick="publishSurvey(@Model.Survey.Id)" class="btn-primary" style="background-color: #2e7d32;">
                            Опубликовать
                        </button>
                    }
                </div>
            </div>
        </div>

        <div class="editor-main">

            <div id="tab-questions" class="tab-content active" style="width: 100%; display: flex; justify-content: center;">

                <div class="questions-container" id="questions-container">

                    <div class="question-block active" style="border-left: 7px solid var(--primary-color);">
                        <input type="text" id="survey-title-input" class="editor-title-input"
                               value="@(Model.Survey.Title ?? "Новая форма")" placeholder="Новая форма"
                               name="Survey.Title">

                        <input type="text" id="survey-description-input" class="question-input"
                               value="@Model.Survey.Description" placeholder="Описание"
                               name="Survey.Description">
                    </div>

                    @* Рендеринг разделов, медиа и вопросов в правильном порядке *@
                    @{
                        // Создаем объединенный список всех элементов с их порядком
                        var allElements = new List<dynamic>();
                        
                        // Добавляем разделы
                        if (Model.Sections != null)
                        {
                            foreach (var section in Model.Sections.OrderBy(s => s.Order))
                            {
                                allElements.Add(new { Type = "Section", Order = section.Order, Data = section });
                            }
                        }
                        
                        // Добавляем медиа
                        if (Model.Media != null)
                        {
                            foreach (var media in Model.Media.OrderBy(m => m.Order))
                            {
                                allElements.Add(new { Type = "Media", Order = media.Order, Data = media });
                            }
                        }
                        
                        // Добавляем вопросы
                        if (Model.Questions != null)
                        {
                            foreach (var question in Model.Questions.OrderBy(q => q.Order))
                            {
                                allElements.Add(new { Type = "Question", Order = question.Order, Data = question });
                            }
                        }
                        
                        // Сортируем по порядку
                        allElements = allElements.OrderBy(e => e.Order).ToList();
                    }
                    
                    @foreach (var element in allElements)
                    {
                        if (element.Type == "Section")
                        {
                            var sectionItem = (Section)element.Data;
                            <div class="question-block section-block" data-section-id="@sectionItem.Id" data-type="section">
                                <input type="hidden" name="Sections[@sectionItem.Id].Id" value="@sectionItem.Id">
                                <div class="section-header">
                                    <input type="text" class="editor-title-input" 
                                           placeholder="Заголовок раздела" 
                                           value="@sectionItem.Title"
                                           name="Sections[@sectionItem.Id].Title"
                                           style="font-size: 1.3rem; font-weight: 600;">
                                    <input type="hidden" name="Sections[@sectionItem.Id].Order" value="@sectionItem.Order">
                                </div>
                                <div class="section-body" style="margin-top: 15px;">
                                    <textarea class="question-input" 
                                              placeholder="Описание раздела (необязательно)" 
                                              name="Sections[@sectionItem.Id].Description"
                                              rows="3"
                                              style="width: 100%; resize: vertical;">@sectionItem.Description</textarea>
                                </div>
                                <div class="question-footer">
                                    <button type="button" class="btn-icon delete-btn" title="Удалить" onclick="deleteElement(this)">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                    <span style="color: #5f6368; font-size: 0.9rem; margin-left: auto;">
                                        <i class="fas fa-layer-group"></i> Раздел
                                    </span>
                                </div>
                            </div>
                        }
                        else if (element.Type == "Media")
                        {
                            var media = (Media)element.Data;
                            <div class="question-block media-block" data-media-id="@media.Id" data-type="@(media.Type == MediaType.Image ? "image" : "video")">
                                <input type="hidden" name="Media[@media.Id].Id" value="@media.Id">
                                <div class="media-header" style="margin-bottom: 15px;">
                                    <i class="fas fa-@(media.Type == MediaType.Image ? "image" : "video")" style="color: var(--primary-green); font-size: 1.5rem; margin-right: 10px;"></i>
                                    <input type="text" class="question-input" 
                                           placeholder="Название @(media.Type == MediaType.Image ? "изображения" : "видео") (необязательно)" 
                                           value="@media.Title"
                                           name="Media[@media.Id].Title"
                                           style="font-size: 1.1rem;">
                                    <input type="hidden" name="Media[@media.Id].Type" value="@media.Type">
                                    <input type="hidden" name="Media[@media.Id].Order" value="@media.Order">
                                </div>
                                <div class="media-body">
                                    @if (media.Type == MediaType.Image)
                                    {
                                        <div class="image-upload-area" style="border: 2px dashed #dadce0; border-radius: 8px; padding: 30px; text-align: center; background: #f5faf5;">
                                            @if (!string.IsNullOrEmpty(media.Url))
                                            {
                                                <img src="@media.Url" alt="@media.Title" style="max-width: 100%; max-height: 300px; border-radius: 8px; margin-bottom: 15px;">
                                            }
                                            else
                                            {
                                                <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: var(--primary-green); margin-bottom: 15px; display: block;"></i>
                                                <p style="color: #5f6368; margin-bottom: 10px;">Перетащите изображение сюда или</p>
                                            }
                                            <label class="btn-primary" style="display: inline-block; cursor: pointer;">
                                                Выбрать файл
                                                <input type="file" accept="image/*" style="display: none;" 
                                                       onchange="handleImageUpload(this, @media.Id)" 
                                                       name="Media[@media.Id].File">
                                            </label>
                                            <input type="text" class="question-input" 
                                                   placeholder="или введите URL изображения" 
                                                   value="@media.Url"
                                                   name="Media[@media.Id].Url"
                                                   style="margin-top: 15px;">
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="video-upload-area" style="border: 2px dashed #dadce0; border-radius: 8px; padding: 30px; text-align: center; background: #f5faf5;">
                                            <i class="fas fa-play-circle" style="font-size: 3rem; color: var(--primary-green); margin-bottom: 15px; display: block;"></i>
                                            <p style="color: #5f6368; margin-bottom: 10px;">Вставьте ссылку на YouTube или введите URL</p>
                                            <input type="text" class="question-input" 
                                                   placeholder="https://www.youtube.com/watch?v=..." 
                                                   value="@media.Url"
                                                   name="Media[@media.Id].Url"
                                                   style="margin-top: 10px; width: 100%;">
                                            <p style="color: #999; font-size: 0.85rem; margin-top: 10px;">
                                                Поддерживаются: YouTube, Vimeo, или прямая ссылка на видео
                                            </p>
                                        </div>
                                    }
                                    <textarea class="question-input" 
                                              placeholder="Описание @(media.Type == MediaType.Image ? "изображения" : "видео") (необязательно)" 
                                              name="Media[@media.Id].Description"
                                              rows="2"
                                              style="margin-top: 15px; width: 100%; resize: vertical;">@media.Description</textarea>
                                </div>
                                <div class="question-footer">
                                    <button type="button" class="btn-icon delete-btn" title="Удалить" onclick="deleteElement(this)">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                    <span style="color: #5f6368; font-size: 0.9rem; margin-left: auto;">
                                        <i class="fas fa-@(media.Type == MediaType.Image ? "image" : "video")"></i> @(media.Type == MediaType.Image ? "Изображение" : "Видео")
                                    </span>
                                </div>
                            </div>
                        }
                        else if (element.Type == "Question")
                        {
                            var question = (Question)element.Data;
                            // Рендеринг сохраненного вопроса (упрощенный пример)
                            <div class="question-block" data-question-id="@question.Id">
                                <input type="hidden" name="Questions[@question.Id].Id" value="@question.Id">
                                <input type="hidden" name="Questions[@question.Id].Order" value="@question.Order">
                                <div class="question-header">
                                    <div class="drag-handle">
                                        <i class="fas fa-grip-vertical"></i>
                                    </div>
                                    <input type="text" class="question-input question-text-input"
                                           placeholder="Вопрос без заголовка"
                                           value="@question.Text"
                                           name="Questions[@question.Id].Text">

                                    <select class="form-control question-type-select"
                                            name="Questions[@question.Id].Type"
                                            data-question-id="@question.Id"
                                            onchange="changeQuestionType(this, @question.Id)">
                                        <option value="SingleChoice" selected="@(question.Type == QuestionType.SingleChoice)">Один из списка</option>
                                        <option value="MultipleChoice" selected="@(question.Type == QuestionType.MultipleChoice)">Несколько из списка</option>
                                        <option value="Dropdown" selected="@(question.Type == QuestionType.Dropdown)">Раскрывающийся список</option>
                                        <option value="ShortText" selected="@(question.Type == QuestionType.ShortText)">Текст (строка)</option>
                                        <option value="ParagraphText" selected="@(question.Type == QuestionType.ParagraphText)">Текст (абзац)</option>
                                        <option value="FileUpload" selected="@(question.Type == QuestionType.FileUpload)">Загрузка файлов</option>
                                        <option value="Scale" selected="@(question.Type == QuestionType.Scale)">Шкала</option>
                                        <option value="Rating" selected="@(question.Type == QuestionType.Rating)">Оценка ⭐</option>
                                        <option value="CheckboxGrid" selected="@(question.Type == QuestionType.CheckboxGrid)">Сетка (множественный выбор)</option>
                                        <option value="RadioGrid" selected="@(question.Type == QuestionType.RadioGrid)">Сетка флажков</option>
                                        <option value="Date" selected="@(question.Type == QuestionType.Date)">Дата</option>
                                        <option value="Time" selected="@(question.Type == QuestionType.Time)">Время</option>
                                    </select>
                                </div>
                                <div class="question-body options-container" data-question-id="@question.Id">
                                    @if (question.Options != null && question.Options.Any())
                                    {
                                        foreach (var option in question.Options.OrderBy(o => o.Order))
                                        {
                                            <div class="option-item" data-option-id="@option.Id">
                                                <input type="hidden" name="Questions[@question.Id].Options[@option.Id].Id" value="@option.Id">
                                                <div class="option-drag-handle">
                                                    <i class="fas fa-grip-vertical"></i>
                                                </div>
                                                <input type="@(question.Type == QuestionType.MultipleChoice ? "checkbox" : "radio")" disabled style="margin-right: 10px;">
                                                <input type="text" class="option-input"
                                                       value="@option.Text"
                                                       name="Questions[@question.Id].Options[@option.Id].Text">
                                                <input type="hidden" name="Questions[@question.Id].Options[@option.Id].Order" value="@option.Order">
                                                <button type="button" class="btn-icon delete-option-btn" onclick="deleteOption(this)">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </div>
                                        }
                                    }
                                    <div class="add-option-area" onclick="addOptionToQuestion(@question.Id)">
                                        <input type="@(question.Type == QuestionType.MultipleChoice ? "checkbox" : "radio")" disabled style="margin-right: 10px;">
                                        <span class="add-option-link">Добавить вариант</span>
                                    </div>
                                </div>
                                <div class="question-footer">
                                    <button type="button" class="btn-icon duplicate-btn" title="Дублировать" onclick="duplicateQuestion(this)"><i class="far fa-copy"></i></button>
                                    <button type="button" class="btn-icon delete-btn" title="Удалить" onclick="deleteQuestion(this)"><i class="fas fa-trash-alt"></i></button>
                                    <div class="separator-line"></div>
                                    <label class="required-label">
                                        Обязательный вопрос
                                        <input type="checkbox" class="required-toggle" name="Questions[@question.Id].IsRequired" @(question.IsRequired ? "checked" : "")>
                                    </label>
                                </div>
                            </div>
                        }
                    }

                    <input type="hidden" id="deleted-elements" name="DeletedElements" value="" />

                </div>
            </div>

            <!-- Летающий Бар (FAB - Floating Action Bar) -->
            <div class="fab-container">
                <div class="fab-menu" id="fab-menu">
                    <div class="fab-item" onclick="addNewQuestion()">
                        <span class="fab-label">Добавить вопрос</span>
                        <button type="button" class="fab-action" title="Добавить вопрос">
                            ➕
                        </button>
                    </div>
                    <div class="fab-item" onclick="addSection()">
                        <span class="fab-label">Добавить раздел</span>
                        <button type="button" class="fab-action" title="Добавить раздел">
                            📑
                        </button>
                    </div>
                    <div class="fab-item" onclick="addImage()">
                        <span class="fab-label">Добавить фото</span>
                        <button type="button" class="fab-action" title="Добавить фото">
                            🖼️
                        </button>
                    </div>
                    <div class="fab-item" onclick="addVideo()">
                        <span class="fab-label">Добавить видео</span>
                        <button type="button" class="fab-action" title="Добавить видео">
                            🎬
                        </button>
                    </div>
                    <div class="fab-item" onclick="addTextBlock()">
                        <span class="fab-label">Добавить текст</span>
                        <button type="button" class="fab-action" title="Добавить текстовый блок">
                            📝
                        </button>
                    </div>
                </div>
                <button type="button" class="fab-main" id="fab-main" onclick="toggleFabMenu()">
                    ➕
                </button>
            </div>
            </div>

            <!-- Вкладка Ответы -->
            <div id="tab-answers" class="tab-content" style="display: none;">
                <div class="answers-container">
                    @if (Model.ResultsData == null || Model.ResultsData.TotalResponses == 0)
                    {
                        <div class="answers-empty-state">
                            <div class="empty-state-icon">
                                <i class="fas fa-chart-bar"></i>
                            </div>
                            <h3 class="empty-state-title">Пока нет ответов</h3>
                            <p class="empty-state-text">
                                Когда пользователи начнут проходить ваш опрос, результаты появятся здесь.
                            </p>
                            @if (!Model.Survey.IsPublished)
                            {
                                <div class="empty-state-action">
                                    <button type="button" onclick="publishSurvey(@Model.Survey.Id)" class="btn-publish-empty">
                                        <i class="fas fa-paper-plane"></i>
                                        Опубликовать опрос
                                    </button>
                                </div>
                            }
                            else
                            {
                                <div class="empty-state-link">
                                    <a asp-controller="Public" asp-action="ViewSurvey" asp-route-id="@Model.Survey.Id" target="_blank" class="link-view-survey">
                                        <i class="fas fa-external-link-alt"></i>
                                        Открыть опрос
                                    </a>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <!-- Заголовок с статистикой -->
                        <div class="answers-header">
                            <div class="answers-header-content">
                                <h2 class="answers-title">@Model.ResultsData.SurveyTitle</h2>
                                <div class="answers-stats">
                                    <div class="stat-item">
                                        <i class="fas fa-users"></i>
                                        <span class="stat-value">@Model.ResultsData.TotalResponses</span>
                                        <span class="stat-label">ответов</span>
                                    </div>
                                    <div class="stat-item">
                                        <i class="fas fa-calendar"></i>
                                        <span class="stat-value">@Model.ResultsData.CreationDate.ToString("dd.MM.yyyy")</span>
                                    </div>
                                </div>
                            </div>
                            <div class="answers-header-actions">
                                <button type="button" class="btn-export" onclick="exportResponses()" title="Экспорт ответов">
                                    <i class="fas fa-download"></i>
                                    Экспорт
                                </button>
                                <a asp-controller="Public" asp-action="ViewSurvey" asp-route-id="@Model.Survey.Id" target="_blank" class="btn-view-survey">
                                    <i class="fas fa-external-link-alt"></i>
                                    Открыть опрос
                                </a>
                            </div>
                        </div>

                        <!-- Результаты по вопросам -->
                        <div class="answers-content">
                            @foreach (var questionResult in Model.ResultsData.QuestionResults)
                            {
                                <div class="answer-question-card">
                                    <h3 class="answer-question-title">@questionResult.Text</h3>

                                    @if (questionResult.Type == QuestionType.ShortText || questionResult.Type == QuestionType.ParagraphText)
                                    {
                                        <!-- Текстовые ответы -->
                                        <div class="text-answers-list">
                                            @if (questionResult.TextAnswers != null && questionResult.TextAnswers.Any())
                                            {
                                                <div class="text-answers-scroll">
                                                    @foreach (var textAnswer in questionResult.TextAnswers)
                                                    {
                                                        <div class="text-answer-item">
                                                            <i class="fas fa-quote-left"></i>
                                                            <span>@textAnswer</span>
                                                        </div>
                                                    }
                                                </div>
                                                <div class="text-answers-count">
                                                    Всего ответов: @questionResult.TextAnswers.Count
                                                </div>
                                            }
                                            else
                                            {
                                                <div class="no-answers">
                                                    <i class="fas fa-inbox"></i>
                                                    <span>Нет ответов</span>
                                                </div>
                                            }
                                        </div>
                                    }
                                    else if (questionResult.Type == QuestionType.SingleChoice || questionResult.Type == QuestionType.MultipleChoice)
                                    {
                                        <!-- Ответы с выбором вариантов -->
                                        <div class="choice-answers">
                                            @if (questionResult.OptionTexts != null && questionResult.OptionTexts.Any())
                                            {
                                                var totalVotes = questionResult.OptionCounts.Values.Sum();
                                                @foreach (var option in questionResult.OptionTexts)
                                                {
                                                    var count = questionResult.OptionCounts.ContainsKey(option.Key) ? questionResult.OptionCounts[option.Key] : 0;
                                                    var percentage = totalVotes > 0 ? (count * 100.0 / totalVotes) : 0;
                                                    
                                                    <div class="choice-answer-item">
                                                        <div class="choice-answer-header">
                                                            <span class="choice-answer-text">@option.Value</span>
                                                            <span class="choice-answer-stats">@count (@percentage.ToString("F1"))%</span>
                                                        </div>
                                                        <div class="choice-answer-bar">
                                                            <div class="choice-answer-bar-fill" style="width: @percentage%"></div>
                                                        </div>
                                                    </div>
                                                }
                                                <div class="choice-answers-total">
                                                    Всего ответов: @totalVotes
                                                </div>
                                            }
                                        </div>
                                    }
                                    else if (questionResult.Type == QuestionType.Scale)
                                    {
                                        <!-- Шкала -->
                                        <div class="scale-answers">
                                            <div class="scale-average">
                                                <div class="scale-average-value">@questionResult.AverageScore.ToString("F2")</div>
                                                <div class="scale-average-label">Средний балл</div>
                                            </div>
                                            
                                            @if (questionResult.OptionTexts != null && questionResult.OptionTexts.Any())
                                            {
                                                var totalVotes = questionResult.OptionCounts.Values.Sum();
                                                <div class="scale-distribution">
                                                    @foreach (var option in questionResult.OptionTexts.OrderBy(o => o.Value))
                                                    {
                                                        var count = questionResult.OptionCounts.ContainsKey(option.Key) ? questionResult.OptionCounts[option.Key] : 0;
                                                        var percentage = totalVotes > 0 ? (count * 100.0 / totalVotes) : 0;
                                                        
                                                        <div class="scale-item">
                                                            <div class="scale-item-header">
                                                                <span class="scale-item-label">@option.Value</span>
                                                                <span class="scale-item-count">@count</span>
                                                            </div>
                                                            <div class="scale-item-bar">
                                                                <div class="scale-item-bar-fill" style="width: @percentage%"></div>
                                                            </div>
                                                        </div>
                                                    }
                                                </div>
                                            }
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="no-answers">
                                            <i class="fas fa-info-circle"></i>
                                            <span>Тип вопроса не поддерживает отображение статистики</span>
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>

            <div id="tab-settings" class="tab-content" style="display: none;">
                <div class="settings-container">
                    <!-- Раздел: Тест -->
                    <div class="settings-section">
                        <div class="settings-section-header">
                            <div class="settings-section-title-row">
                                <h3 class="settings-section-title">Тест</h3>
                                <label class="toggle-switch">
                                    <input type="checkbox" name="Survey.IsTestMode" id="isTestMode" 
                                           @(Model.Survey.IsTestMode ? "checked" : "") 
                                           onchange="toggleTestMode()">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <p class="settings-section-description">
                                Настройка максимальных баллов, указание ответов и автоматическая отправка отзывов
                            </p>
                        </div>

                        <div id="test-settings-content" class="settings-section-content" style="@(Model.Survey.IsTestMode ? "" : "display: none;")">
                            <!-- ПУБЛИКАЦИЯ ОЦЕНОК -->
                            <div class="settings-subsection">
                                <h4 class="settings-subsection-title">ПУБЛИКАЦИЯ ОЦЕНОК</h4>
                                <div class="radio-group">
                                    <label class="radio-option">
                                        <input type="radio" name="Survey.GradePublication" value="1" 
                                               @(Model.Survey.GradePublication == GradePublicationType.Immediately ? "checked" : "")
                                               id="gradeImmediately">
                                        <span class="radio-label">Сразу после отправки формы</span>
                                    </label>
                                    <label class="radio-option">
                                        <input type="radio" name="Survey.GradePublication" value="2" 
                                               @(Model.Survey.GradePublication == GradePublicationType.AfterManualReview ? "checked" : "")
                                               id="gradeAfterReview">
                                        <span class="radio-label">После ручной проверки</span>
                                    </label>
                                </div>
                                <p class="settings-note">
                                    Будет включен параметр "Ответы → Собирать адреса электронной почты"
                                </p>
                            </div>

                            <!-- НАСТРОЙКИ РЕСПОНДЕНТОВ -->
                            <div class="settings-subsection">
                                <h4 class="settings-subsection-title">НАСТРОЙКИ РЕСПОНДЕНТОВ</h4>
                                
                                <div class="toggle-option">
                                    <div class="toggle-option-content">
                                        <div class="toggle-option-text">
                                            <strong>Незачтенные ответы</strong>
                                            <p class="toggle-option-description">Респонденты могут видеть, на какие вопросы даны неверные ответы.</p>
                                        </div>
                                        <label class="toggle-switch small">
                                            <input type="checkbox" name="Survey.ShowIncorrectAnswers" 
                                                   @(Model.Survey.ShowIncorrectAnswers ? "checked" : "")>
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </div>
                                </div>

                                <div class="toggle-option">
                                    <div class="toggle-option-content">
                                        <div class="toggle-option-text">
                                            <strong>Правильные ответы</strong>
                                            <p class="toggle-option-description">Респондентам показываются правильные ответы после выставления оценок.</p>
                                        </div>
                                        <label class="toggle-switch small">
                                            <input type="checkbox" name="Survey.ShowCorrectAnswers" 
                                                   @(Model.Survey.ShowCorrectAnswers ? "checked" : "")>
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </div>
                                </div>

                                <div class="toggle-option">
                                    <div class="toggle-option-content">
                                        <div class="toggle-option-text">
                                            <strong>Баллы за ответы</strong>
                                            <p class="toggle-option-description">Респондентам показываются как баллы, полученные за каждый вопрос, так и общее количество баллов.</p>
                                        </div>
                                        <label class="toggle-switch small">
                                            <input type="checkbox" name="Survey.ShowPoints" 
                                                   @(Model.Survey.ShowPoints ? "checked" : "")>
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- ОБЩИЕ ПАРАМЕТРЫ ОПРОСА ПО УМОЛЧАНИЮ -->
                            <div class="settings-subsection">
                                <h4 class="settings-subsection-title">ОБЩИЕ ПАРАМЕТРЫ ОПРОСА ПО УМОЛЧАНИЮ</h4>
                                <div class="input-option">
                                    <label class="input-label">
                                        Максимальный балл за вопрос по умолчанию
                                    </label>
                                    <p class="input-description">Максимальные баллы за каждый новый вопрос</p>
                                    <div class="input-with-suffix">
                                        <input type="number" name="Survey.DefaultMaxPoints" 
                                               value="@Model.Survey.DefaultMaxPoints" 
                                               min="0" class="settings-input" id="defaultMaxPoints">
                                        <span class="input-suffix">балл.</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Раздел: Ответы (сворачиваемый) -->
                    <div class="settings-section collapsible">
                        <div class="settings-section-header collapsible-header" onclick="toggleCollapsible(this)">
                            <div class="settings-section-title-row">
                                <h3 class="settings-section-title">Ответы</h3>
                                <i class="fas fa-chevron-down collapsible-icon"></i>
                            </div>
                            <p class="settings-section-description">
                                Управление сбором и защитой ответов.
                            </p>
                        </div>
                        <div class="settings-section-content collapsible-content" style="display: none;">
                            <p class="settings-placeholder">Настройки ответов будут здесь</p>
                        </div>
                    </div>

                    <!-- Раздел: Презентация (сворачиваемый) -->
                    <div class="settings-section collapsible">
                        <div class="settings-section-header collapsible-header" onclick="toggleCollapsible(this)">
                            <div class="settings-section-title-row">
                                <h3 class="settings-section-title">Презентация</h3>
                                <i class="fas fa-chevron-down collapsible-icon"></i>
                            </div>
                            <p class="settings-section-description">
                                Управление представлением формы и ответов на ее вопросы.
                            </p>
                        </div>
                        <div class="settings-section-content collapsible-content" style="display: none;">
                            <p class="settings-placeholder">Настройки презентации будут здесь</p>
                        </div>
                    </div>

                    <!-- Раздел: Значения по умолчанию (сворачиваемый) -->
                    <div class="settings-section collapsible">
                        <div class="settings-section-header collapsible-header" onclick="toggleCollapsible(this)">
                            <div class="settings-section-title-row">
                                <h3 class="settings-section-title">Значения по умолчанию</h3>
                                <i class="fas fa-chevron-down collapsible-icon"></i>
                            </div>
                        </div>
                        <div class="settings-section-content collapsible-content" style="display: none;">
                            <div class="settings-subsection">
                                <div class="collapsible-subsection">
                                    <div class="settings-section-header collapsible-header" onclick="toggleCollapsible(this)">
                                        <div class="settings-section-title-row">
                                            <h4 class="settings-subsection-title">Настройки форм по умолчанию</h4>
                                            <i class="fas fa-chevron-down collapsible-icon"></i>
                                        </div>
                                        <p class="settings-section-description">
                                            Настройки, которые будут действовать для текущей и новых форм
                                        </p>
                                    </div>
                                    <div class="settings-section-content collapsible-content" style="display: none;">
                                        <p class="settings-placeholder">Настройки будут здесь</p>
                                    </div>
                                </div>
                            </div>
                            <div class="settings-subsection">
                                <div class="collapsible-subsection">
                                    <div class="settings-section-header collapsible-header" onclick="toggleCollapsible(this)">
                                        <div class="settings-section-title-row">
                                            <h4 class="settings-subsection-title">Настройки вопросов по умолчанию</h4>
                                            <i class="fas fa-chevron-down collapsible-icon"></i>
                                        </div>
                                        <p class="settings-section-description">
                                            Настройки, которые будут действовать для всех новых вопросов
                                        </p>
                                    </div>
                                    <div class="settings-section-content collapsible-content" style="display: none;">
                                        <p class="settings-placeholder">Настройки будут здесь</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- Боковая панель настроек темы -->
        <div id="theme-panel" class="theme-panel">
            <div class="theme-panel-header">
                <h3 class="theme-panel-title">Тема</h3>
                <button type="button" class="theme-panel-close" onclick="toggleThemePanel()" aria-label="Закрыть">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="theme-panel-content">
                <!-- Стиль текста -->
                <div class="theme-section">
                    <h4 class="theme-section-title">Стиль текста</h4>
                    
                    <div class="theme-option">
                        <label class="theme-option-label">Верхний колонтитул</label>
                        <div class="theme-option-controls">
                            <select name="Survey.HeaderFontFamily" id="headerFontFamily" class="theme-select" onchange="updateThemePreview()">
                                @{
                                    var headerFont = Model.Survey.HeaderFontFamily ?? "Courier New";
                                }
                                <option value="Courier New" selected="@(headerFont == "Courier New")">Courier New</option>
                                <option value="Roboto" selected="@(headerFont == "Roboto")">Roboto</option>
                                <option value="Arial" selected="@(headerFont == "Arial")">Arial</option>
                                <option value="Times New Roman" selected="@(headerFont == "Times New Roman")">Times New Roman</option>
                                <option value="Georgia" selected="@(headerFont == "Georgia")">Georgia</option>
                            </select>
                            <input type="number" name="Survey.HeaderFontSize" id="headerFontSize" class="theme-input-number" 
                                   value="@(Model.Survey.HeaderFontSize ?? 24)" min="10" max="72" onchange="updateThemePreview()">
                        </div>
                    </div>

                    <div class="theme-option">
                        <label class="theme-option-label">Вопрос</label>
                        <div class="theme-option-controls">
                            <select name="Survey.QuestionFontFamily" id="questionFontFamily" class="theme-select" onchange="updateThemePreview()">
                                @{
                                    var questionFont = Model.Survey.QuestionFontFamily ?? "Roboto";
                                }
                                <option value="Roboto" selected="@(questionFont == "Roboto")">Roboto</option>
                                <option value="Courier New" selected="@(questionFont == "Courier New")">Courier New</option>
                                <option value="Arial" selected="@(questionFont == "Arial")">Arial</option>
                                <option value="Times New Roman" selected="@(questionFont == "Times New Roman")">Times New Roman</option>
                                <option value="Georgia" selected="@(questionFont == "Georgia")">Georgia</option>
                            </select>
                            <input type="number" name="Survey.QuestionFontSize" id="questionFontSize" class="theme-input-number" 
                                   value="@(Model.Survey.QuestionFontSize ?? 12)" min="8" max="48" onchange="updateThemePreview()">
                        </div>
                    </div>

                    <div class="theme-option">
                        <label class="theme-option-label">Текст</label>
                        <div class="theme-option-controls">
                            <select name="Survey.TextFontFamily" id="textFontFamily" class="theme-select" onchange="updateThemePreview()">
                                @{
                                    var textFont = Model.Survey.TextFontFamily ?? "Roboto";
                                }
                                <option value="Roboto" selected="@(textFont == "Roboto")">Roboto</option>
                                <option value="Courier New" selected="@(textFont == "Courier New")">Courier New</option>
                                <option value="Arial" selected="@(textFont == "Arial")">Arial</option>
                                <option value="Times New Roman" selected="@(textFont == "Times New Roman")">Times New Roman</option>
                                <option value="Georgia" selected="@(textFont == "Georgia")">Georgia</option>
                            </select>
                            <input type="number" name="Survey.TextFontSize" id="textFontSize" class="theme-input-number" 
                                   value="@(Model.Survey.TextFontSize ?? 11)" min="8" max="48" onchange="updateThemePreview()">
                        </div>
                    </div>
                </div>

                <!-- Верхний колонтитул -->
                <div class="theme-section">
                    <h4 class="theme-section-title">Верхний колонтитул</h4>
                    <div class="theme-image-upload">
                        <input type="file" id="headerImageInput" accept="image/*" style="display: none;" onchange="handleHeaderImageUpload(event)">
                        <button type="button" class="theme-image-button" onclick="document.getElementById('headerImageInput').click()">
                            <i class="fas fa-image"></i>
                            Выберите изображение
                        </button>
                        @if (!string.IsNullOrEmpty(Model.Survey.HeaderImagePath))
                        {
                            <div class="theme-image-preview" id="headerImagePreview">
                                <img src="@Model.Survey.HeaderImagePath" alt="Header">
                                <button type="button" class="theme-image-remove" onclick="removeHeaderImage()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <input type="hidden" name="Survey.HeaderImagePath" id="headerImagePath" value="@Model.Survey.HeaderImagePath">
                        }
                        else
                        {
                            <div class="theme-image-preview" id="headerImagePreview" style="display: none;"></div>
                            <input type="hidden" name="Survey.HeaderImagePath" id="headerImagePath" value="">
                        }
                    </div>
                </div>

                <!-- Цвет -->
                <div class="theme-section">
                    <h4 class="theme-section-title">Цвет</h4>
                    <div class="theme-color-grid">
                        <div class="theme-color-item" data-color="#673AB7" onclick="selectThemeColor('#673AB7')" 
                             style="background-color: #673AB7;" @(Model.Survey.ThemeColor == "#673AB7" ? "data-selected='true'" : "")>
                            @if (Model.Survey.ThemeColor == "#673AB7")
                            {
                                <i class="fas fa-check"></i>
                            }
                        </div>
                        <div class="theme-color-item" data-color="#E91E63" onclick="selectThemeColor('#E91E63')" 
                             style="background-color: #E91E63;" @(Model.Survey.ThemeColor == "#E91E63" ? "data-selected='true'" : "")>
                            @if (Model.Survey.ThemeColor == "#E91E63")
                            {
                                <i class="fas fa-check"></i>
                            }
                        </div>
                        <div class="theme-color-item" data-color="#2196F3" onclick="selectThemeColor('#2196F3')" 
                             style="background-color: #2196F3;" @(Model.Survey.ThemeColor == "#2196F3" ? "data-selected='true'" : "")>
                            @if (Model.Survey.ThemeColor == "#2196F3")
                            {
                                <i class="fas fa-check"></i>
                            }
                        </div>
                        <div class="theme-color-item" data-color="#4CAF50" onclick="selectThemeColor('#4CAF50')" 
                             style="background-color: #4CAF50;" @(Model.Survey.ThemeColor == "#4CAF50" ? "data-selected='true'" : "")>
                            @if (Model.Survey.ThemeColor == "#4CAF50")
                            {
                                <i class="fas fa-check"></i>
                            }
                        </div>
                        <div class="theme-color-item" data-color="#FF9800" onclick="selectThemeColor('#FF9800')" 
                             style="background-color: #FF9800;" @(Model.Survey.ThemeColor == "#FF9800" ? "data-selected='true'" : "")>
                            @if (Model.Survey.ThemeColor == "#FF9800")
                            {
                                <i class="fas fa-check"></i>
                            }
                        </div>
                        <div class="theme-color-item" data-color="#9C27B0" onclick="selectThemeColor('#9C27B0')" 
                             style="background-color: #9C27B0;" @(Model.Survey.ThemeColor == "#9C27B0" ? "data-selected='true'" : "")>
                            @if (Model.Survey.ThemeColor == "#9C27B0")
                            {
                                <i class="fas fa-check"></i>
                            }
                        </div>
                        <div class="theme-color-item" data-color="#F44336" onclick="selectThemeColor('#F44336')" 
                             style="background-color: #F44336;" @(Model.Survey.ThemeColor == "#F44336" ? "data-selected='true'" : "")>
                            @if (Model.Survey.ThemeColor == "#F44336")
                            {
                                <i class="fas fa-check"></i>
                            }
                        </div>
                        <div class="theme-color-item" data-color="#00BCD4" onclick="selectThemeColor('#00BCD4')" 
                             style="background-color: #00BCD4;" @(Model.Survey.ThemeColor == "#00BCD4" ? "data-selected='true'" : "")>
                            @if (Model.Survey.ThemeColor == "#00BCD4")
                            {
                                <i class="fas fa-check"></i>
                            }
                        </div>
                        <button type="button" class="theme-color-add" onclick="openColorPicker()" title="Добавить цвет">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <input type="hidden" name="Survey.ThemeColor" id="themeColor" value="@(Model.Survey.ThemeColor ?? "#673AB7")">
                </div>

                <!-- Фон -->
                <div class="theme-section">
                    <h4 class="theme-section-title">Фон</h4>
                    <div class="theme-background-options">
                        <div class="theme-background-item @(Model.Survey.BackgroundColor == "#F3E5F5" ? "active" : "")" 
                             data-color="#F3E5F5" onclick="selectBackgroundColor('#F3E5F5')" style="background-color: #F3E5F5;"></div>
                        <div class="theme-background-item @(Model.Survey.BackgroundColor == "#FFFFFF" ? "active" : "")" 
                             data-color="#FFFFFF" onclick="selectBackgroundColor('#FFFFFF')" style="background-color: #FFFFFF; border: 1px solid #ddd;"></div>
                        <div class="theme-background-item @(Model.Survey.BackgroundColor == "#F5F5F5" ? "active" : "")" 
                             data-color="#F5F5F5" onclick="selectBackgroundColor('#F5F5F5')" style="background-color: #F5F5F5;"></div>
                    </div>
                    <input type="hidden" name="Survey.BackgroundColor" id="backgroundColor" value="@(Model.Survey.BackgroundColor ?? "#F3E5F5")">
                </div>
            </div>
        </div>

        <!-- Overlay для закрытия панели -->
        <div id="theme-panel-overlay" class="theme-panel-overlay" onclick="toggleThemePanel()"></div>

    </form>

    @section Scripts {
        <script>
            // Показываем сообщения из TempData, если они есть
            @if (TempData["SuccessMessage"] != null)
            {
                <text>
                alert('@Html.Raw(TempData["SuccessMessage"])');
                </text>
            }
            @if (TempData["ErrorMessage"] != null)
            {
                <text>
                alert('@Html.Raw(TempData["ErrorMessage"])');
                </text>
            }

            // JS-функция для переключения вкладок
            function switchTab(event, tabName) {
                event.preventDefault();
                document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
                document.querySelectorAll('.tab-link').forEach(el => el.classList.remove('active'));

                // Активируем нужную вкладку
                const tabContent = document.getElementById('tab-' + tabName);
                if (tabContent) {
                    tabContent.style.display = (tabName === 'questions' ? 'flex' : 'block');
                }
                event.target.classList.add('active');
            }

            // Экспорт ответов
            function exportResponses() {
                const surveyId = document.body.getAttribute('data-survey-id');
                if (!surveyId) {
                    alert('Ошибка: не найден ID опроса');
                    return;
                }
                
                // Открываем страницу экспорта в новом окне
                window.open(`/Survey/Export/${surveyId}`, '_blank');
            }

            // Переключение режима теста
            function toggleTestMode() {
                const isTestMode = document.getElementById('isTestMode').checked;
                const testSettingsContent = document.getElementById('test-settings-content');
                if (isTestMode) {
                    testSettingsContent.style.display = 'block';
                } else {
                    testSettingsContent.style.display = 'none';
                }
            }

            // Переключение сворачиваемых секций
            function toggleCollapsible(header) {
                const content = header.nextElementSibling;
                const icon = header.querySelector('.collapsible-icon');
                
                if (content.style.display === 'none') {
                    content.style.display = 'block';
                    header.classList.add('active');
                } else {
                    content.style.display = 'none';
                    header.classList.remove('active');
                }
            }

            // ====================================
            // СИСТЕМА UNDO/REDO
            // ====================================
            let actionHistory = [];
            let currentHistoryIndex = -1;
            const MAX_HISTORY_SIZE = 50;

            // Сохранение состояния в историю
            function saveState() {
                // Удаляем все состояния после текущего индекса (если делаем новое действие после undo)
                if (currentHistoryIndex < actionHistory.length - 1) {
                    actionHistory = actionHistory.slice(0, currentHistoryIndex + 1);
                }

                // Сохраняем текущее состояние DOM
                const questionsContainer = document.getElementById('questions-container');
                if (!questionsContainer) return;
                
                const state = {
                    html: questionsContainer.innerHTML,
                    timestamp: Date.now()
                };

                actionHistory.push(state);
                currentHistoryIndex = actionHistory.length - 1;

                // Ограничиваем размер истории
                if (actionHistory.length > MAX_HISTORY_SIZE) {
                    actionHistory.shift();
                    currentHistoryIndex--;
                }

                updateUndoRedoButtons();
            }

            // Делаем функцию глобально доступной для constructor.js
            window.saveState = saveState;

            // Отмена действия
            function undoAction() {
                if (currentHistoryIndex > 0) {
                    currentHistoryIndex--;
                    restoreState();
                }
            }

            // Повтор действия
            function redoAction() {
                if (currentHistoryIndex < actionHistory.length - 1) {
                    currentHistoryIndex++;
                    restoreState();
                }
            }

            // Восстановление состояния
            function restoreState() {
                if (actionHistory[currentHistoryIndex]) {
                    window.isRestoringState = true; // Флаг для предотвращения сохранения при восстановлении
                    const questionsContainer = document.getElementById('questions-container');
                    questionsContainer.innerHTML = actionHistory[currentHistoryIndex].html;
                    
                    // Переинициализируем обработчики событий
                    if (typeof setupBlockActivation === 'function') {
                        setupBlockActivation();
                    }
                    updateUndoRedoButtons();
                    
                    setTimeout(() => {
                        window.isRestoringState = false;
                    }, 100);
                }
            }

            // Обновление состояния кнопок undo/redo
            function updateUndoRedoButtons() {
                const undoBtn = document.getElementById('undo-btn');
                const redoBtn = document.getElementById('redo-btn');
                
                undoBtn.disabled = currentHistoryIndex <= 0;
                redoBtn.disabled = currentHistoryIndex >= actionHistory.length - 1;
            }

            // Инициализация истории при загрузке страницы
            document.addEventListener('DOMContentLoaded', function() {
                // Сохраняем начальное состояние
                setTimeout(() => {
                    saveState();
                }, 500);

                // Отслеживаем изменения в вопросах для автоматического сохранения в историю
                const questionsContainer = document.getElementById('questions-container');
                if (questionsContainer) {
                    // Используем MutationObserver для отслеживания изменений DOM
                    const observer = new MutationObserver(function(mutations) {
                        // Игнорируем изменения, вызванные самим undo/redo
                        if (!window.isRestoringState) {
                            // Дебаунс для избежания слишком частых сохранений
                            clearTimeout(window.saveStateTimeout);
                            window.saveStateTimeout = setTimeout(() => {
                                saveState();
                            }, 500);
                        }
                    });

                    observer.observe(questionsContainer, {
                        childList: true,
                        subtree: true,
                        attributes: true,
                        attributeFilter: ['value', 'checked', 'selected']
                    });
                }

                // Отслеживаем изменения в полях ввода
                document.addEventListener('input', function(e) {
                    if (e.target.closest('#questions-container') && !window.isRestoringState) {
                        clearTimeout(window.saveStateTimeout);
                        window.saveStateTimeout = setTimeout(() => {
                            saveState();
                        }, 1000);
                    }
                });
            });

            // Обработка горячих клавиш
            document.addEventListener('keydown', function(e) {
                if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
                    e.preventDefault();
                    undoAction();
                } else if ((e.ctrlKey || e.metaKey) && (e.key === 'y' || (e.key === 'z' && e.shiftKey))) {
                    e.preventDefault();
                    redoAction();
                }
            });

            // ====================================
            // ПРЕДПРОСМОТР ФОРМЫ
            // ====================================
            function openPreview() {
                const surveyId = document.body.getAttribute('data-survey-id');
                if (!surveyId) {
                    alert('Ошибка: не найден ID опроса');
                    return;
                }
                
                // Открываем предпросмотр в новом окне
                const previewUrl = `/Survey/Preview/${surveyId}`;
                window.open(previewUrl, '_blank', 'width=1200,height=800');
            }

            // Переключение панели темы
            function toggleThemePanel() {
                const panel = document.getElementById('theme-panel');
                const overlay = document.getElementById('theme-panel-overlay');
                
                if (panel.classList.contains('active')) {
                    panel.classList.remove('active');
                    overlay.style.display = 'none';
                } else {
                    panel.classList.add('active');
                    overlay.style.display = 'block';
                }
            }

            // Выбор цвета темы
            function selectThemeColor(color) {
                document.getElementById('themeColor').value = color;
                document.querySelectorAll('.theme-color-item').forEach(item => {
                    item.classList.remove('selected');
                    item.innerHTML = '';
                });
                
                const selectedItem = document.querySelector(`.theme-color-item[data-color="${color}"]`);
                if (selectedItem) {
                    selectedItem.classList.add('selected');
                    selectedItem.innerHTML = '<i class="fas fa-check"></i>';
                }
                
                updateThemePreview();
            }

            // Выбор цвета фона
            function selectBackgroundColor(color) {
                document.getElementById('backgroundColor').value = color;
                document.querySelectorAll('.theme-background-item').forEach(item => {
                    item.classList.remove('active');
                });
                
                const selectedItem = document.querySelector(`.theme-background-item[data-color="${color}"]`);
                if (selectedItem) {
                    selectedItem.classList.add('active');
                }
                
                updateThemePreview();
            }

            // Обновление превью темы
            function updateThemePreview() {
                const themeColor = document.getElementById('themeColor').value;
                const backgroundColor = document.getElementById('backgroundColor').value;
                
                // Применяем цвета к элементам формы
                document.documentElement.style.setProperty('--theme-color', themeColor);
                document.documentElement.style.setProperty('--theme-bg', backgroundColor);
                
                // Обновляем шрифты
                const headerFont = document.getElementById('headerFontFamily').value;
                const headerSize = document.getElementById('headerFontSize').value;
                const questionFont = document.getElementById('questionFontFamily').value;
                const questionSize = document.getElementById('questionFontSize').value;
                const textFont = document.getElementById('textFontFamily').value;
                const textSize = document.getElementById('textFontSize').value;
                
                // Применяем к превью (можно расширить для реального превью)
                const titleInput = document.getElementById('survey-title-input');
                if (titleInput) {
                    titleInput.style.fontFamily = headerFont;
                    titleInput.style.fontSize = headerSize + 'px';
                }
            }

            // Загрузка изображения заголовка
            function handleHeaderImageUpload(event) {
                const file = event.target.files[0];
                if (!file) return;

                if (!file.type.startsWith('image/')) {
                    alert('Пожалуйста, выберите изображение');
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('headerImagePreview');
                    const pathInput = document.getElementById('headerImagePath');
                    
                    preview.innerHTML = `
                        <img src="${e.target.result}" alt="Header">
                        <button type="button" class="theme-image-remove" onclick="removeHeaderImage()">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    preview.style.display = 'block';
                    
                    // Здесь можно добавить загрузку на сервер через AJAX
                    // Пока сохраняем как base64 или временный путь
                    pathInput.value = e.target.result; // Временное решение
                };
                reader.readAsDataURL(file);
            }

            // Удаление изображения заголовка
            function removeHeaderImage() {
                const preview = document.getElementById('headerImagePreview');
                const pathInput = document.getElementById('headerImagePath');
                const fileInput = document.getElementById('headerImageInput');
                
                preview.style.display = 'none';
                preview.innerHTML = '';
                pathInput.value = '';
                if (fileInput) fileInput.value = '';
            }

            // Открытие цветового пикера (заглушка)
            function openColorPicker() {
                const color = prompt('Введите цвет в формате HEX (например, #FF5733):', '#673AB7');
                if (color && /^#[0-9A-F]{6}$/i.test(color)) {
                    // Добавляем новый цвет в сетку
                    const grid = document.querySelector('.theme-color-grid');
                    const newColorItem = document.createElement('div');
                    newColorItem.className = 'theme-color-item';
                    newColorItem.setAttribute('data-color', color);
                    newColorItem.style.backgroundColor = color;
                    newColorItem.onclick = () => selectThemeColor(color);
                    newColorItem.innerHTML = '';
                    
                    // Вставляем перед кнопкой добавления
                    const addButton = document.querySelector('.theme-color-add');
                    grid.insertBefore(newColorItem, addButton);
                }
            }

            // JS-функция для сохранения опросника
            function saveSurvey() {
                // Собираем данные формы
                const formData = collectFormData();
                
                // Валидация данных перед отправкой
                if (!formData.Title || formData.Title.trim() === '') {
                    showSaveMessage('Ошибка: укажите заголовок опроса', 'error');
                    return;
                }
                
                console.log('Отправляемые данные:', JSON.stringify(formData, null, 2));
                
                // Получаем токен из формы
                var token = document.querySelector('input[name="__RequestVerificationToken"]')?.value || '';
                
                // Если токен не найден в форме, пытаемся получить из cookie
                if (!token) {
                    var cookies = document.cookie.split(';');
                    for (var i = 0; i < cookies.length; i++) {
                        var cookie = cookies[i].trim();
                        if (cookie.startsWith('__RequestVerificationToken=')) {
                            token = cookie.substring('__RequestVerificationToken='.length);
                            break;
                        }
                    }
                }
                
                if (!token) {
                    alert('Ошибка: не найден токен безопасности. Перезагрузите страницу и попробуйте снова.');
                    return;
                }

                // Показываем индикатор загрузки
                const saveButton = document.querySelector('button[onclick="saveSurvey()"]');
                const originalText = saveButton ? saveButton.textContent : 'Сохранить';
                if (saveButton) {
                    saveButton.disabled = true;
                    saveButton.textContent = 'Сохранение...';
                }

                // Отправляем данные через AJAX
                fetch('/api/surveys/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': token
                    },
                    credentials: 'include',
                    body: JSON.stringify(formData)
                })
                .then(async response => {
                    const contentType = response.headers.get('content-type');
                    console.log('Response status:', response.status, 'Content-Type:', contentType);
                    
                    if (contentType && contentType.includes('application/json')) {
                        const data = await response.json();
                        console.log('Response data:', data);
                        return { ok: response.ok, status: response.status, data: data };
                    } else {
                        const text = await response.text();
                        console.error('Non-JSON response:', text);
                        throw new Error(text || `Ошибка сохранения: ${response.status} ${response.statusText}`);
                    }
                })
                .then(result => {
                    if (result.ok && result.data.Success) {
                        // Показываем сообщение об успехе
                        showSaveMessage('Опросник успешно сохранен!', 'success');
                    } else {
                        // Обрабатываем ошибки валидации
                        let errorMessage = 'Ошибка при сохранении';
                        if (result.data && result.data.Message) {
                            errorMessage = result.data.Message;
                        } else if (result.data && result.data.Errors) {
                            // Пытаемся извлечь сообщения об ошибках из ModelState
                            const errors = [];
                            for (const key in result.data.Errors) {
                                if (result.data.Errors[key] && result.data.Errors[key].Errors) {
                                    result.data.Errors[key].Errors.forEach(err => {
                                        if (err.ErrorMessage) {
                                            errors.push(err.ErrorMessage);
                                        }
                                    });
                                }
                            }
                            if (errors.length > 0) {
                                errorMessage = errors.join('; ');
                            }
                        }
                        throw new Error(errorMessage);
                    }
                })
                .catch(error => {
                    console.error('Error details:', error);
                    console.error('Error stack:', error.stack);
                    const errorMessage = error.message || 'Неизвестная ошибка';
                    showSaveMessage('Ошибка при сохранении: ' + errorMessage, 'error');
                })
                .finally(() => {
                    // Восстанавливаем кнопку
                    if (saveButton) {
                        saveButton.disabled = false;
                        saveButton.textContent = originalText;
                    }
                });
            }

            // Функция для отображения сообщений о сохранении
            function showSaveMessage(message, type) {
                // Удаляем предыдущее сообщение, если есть
                const existingMessage = document.getElementById('save-message');
                if (existingMessage) {
                    existingMessage.remove();
                }

                // Создаем новое сообщение
                const messageDiv = document.createElement('div');
                messageDiv.id = 'save-message';
                messageDiv.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 15px 20px;
                    background-color: ${type === 'success' ? '#4caf50' : '#f44336'};
                    color: white;
                    border-radius: 4px;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
                    z-index: 10000;
                    font-size: 14px;
                    max-width: 300px;
                    animation: slideIn 0.3s ease-out;
                `;
                messageDiv.textContent = message;

                // Добавляем анимацию
                const style = document.createElement('style');
                style.textContent = `
                    @@keyframes slideIn {
                        from {
                            transform: translateX(100%);
                            opacity: 0;
                        }
                        to {
                            transform: translateX(0);
                            opacity: 1;
                        }
                    }
                    @@keyframes slideOut {
                        from {
                            transform: translateX(0);
                            opacity: 1;
                        }
                        to {
                            transform: translateX(100%);
                            opacity: 0;
                        }
                    }
                `;
                if (!document.querySelector('style[data-save-message]')) {
                    style.setAttribute('data-save-message', 'true');
                    document.head.appendChild(style);
                }

                document.body.appendChild(messageDiv);

                // Автоматически удаляем сообщение через 3 секунды
                setTimeout(() => {
                    messageDiv.style.animation = 'slideOut 0.3s ease-out';
                    setTimeout(() => {
                        if (messageDiv.parentNode) {
                            messageDiv.remove();
                        }
                    }, 300);
                }, 3000);
            }

            // Функция для сбора данных формы и преобразования в JSON
            function collectFormData() {
                const form = document.getElementById('survey-form');
                const formData = new FormData(form);
                const surveyId = parseInt(form.querySelector('input[name="Survey.Id"]')?.value || '0');
                
                // Собираем настройки теста
                const isTestMode = form.querySelector('#isTestMode')?.checked || false;
                const gradePublication = form.querySelector('input[name="Survey.GradePublication"]:checked')?.value || '2';
                const showIncorrectAnswers = form.querySelector('input[name="Survey.ShowIncorrectAnswers"]')?.checked || false;
                const showCorrectAnswers = form.querySelector('input[name="Survey.ShowCorrectAnswers"]')?.checked || false;
                const showPoints = form.querySelector('input[name="Survey.ShowPoints"]')?.checked || false;
                const defaultMaxPoints = parseInt(form.querySelector('#defaultMaxPoints')?.value || '0');

                // Собираем настройки темы
                const themeColor = form.querySelector('#themeColor')?.value || '#673AB7';
                const backgroundColor = form.querySelector('#backgroundColor')?.value || '#F3E5F5';
                const headerImagePath = form.querySelector('#headerImagePath')?.value || '';
                const headerFontFamily = form.querySelector('#headerFontFamily')?.value || 'Courier New';
                const headerFontSize = parseInt(form.querySelector('#headerFontSize')?.value || '24');
                const questionFontFamily = form.querySelector('#questionFontFamily')?.value || 'Roboto';
                const questionFontSize = parseInt(form.querySelector('#questionFontSize')?.value || '12');
                const textFontFamily = form.querySelector('#textFontFamily')?.value || 'Roboto';
                const textFontSize = parseInt(form.querySelector('#textFontSize')?.value || '11');

                const data = {
                    Id: surveyId || null,
                    Title: form.querySelector('#survey-title-input')?.value || '',
                    Description: form.querySelector('#survey-description-input')?.value || '',
                    Type: 'Questionnaire', // Используем строковое значение enum
                    IsPublished: false,
                    IsAnonymous: true,
                    IsTestMode: isTestMode,
                    GradePublication: parseInt(gradePublication),
                    ShowIncorrectAnswers: showIncorrectAnswers,
                    ShowCorrectAnswers: showCorrectAnswers,
                    ShowPoints: showPoints,
                    DefaultMaxPoints: defaultMaxPoints,
                    ThemeColor: themeColor,
                    BackgroundColor: backgroundColor,
                    HeaderImagePath: headerImagePath,
                    HeaderFontFamily: headerFontFamily,
                    HeaderFontSize: headerFontSize,
                    QuestionFontFamily: questionFontFamily,
                    QuestionFontSize: questionFontSize,
                    TextFontFamily: textFontFamily,
                    TextFontSize: textFontSize,
                    Questions: []
                };
                
                // Собираем вопросы
                const questionBlocks = document.querySelectorAll('.question-block[data-question-id]');
                let questionOrder = 0;
                
                questionBlocks.forEach(block => {
                    const questionIdAttr = block.getAttribute('data-question-id');
                    const questionId = questionIdAttr && questionIdAttr.startsWith('-') ? null : parseInt(questionIdAttr);
                    const textInput = block.querySelector('.question-text-input');
                    const typeSelect = block.querySelector('.question-type-select');
                    const isRequired = block.querySelector('.required-toggle')?.checked || false;
                    
                    if (!textInput || !textInput.value.trim()) {
                        return; // Пропускаем вопросы без текста
                    }
                    
                    const questionType = typeSelect ? typeSelect.value : 'SingleChoice';
                    
                    const question = {
                        Id: questionId || null,
                        Order: questionOrder++,
                        Text: textInput.value.trim(),
                        Type: questionType, // ASP.NET Core автоматически преобразует строку в enum
                        IsRequired: isRequired,
                        Options: []
                    };
                    
                    // Собираем варианты ответов
                    const optionItems = block.querySelectorAll('.option-item[data-option-id]');
                    let optionOrder = 0;
                    
                    optionItems.forEach(optionItem => {
                        const optionIdAttr = optionItem.getAttribute('data-option-id');
                        const optionId = optionIdAttr && optionIdAttr.startsWith('-') ? null : parseInt(optionIdAttr);
                        const optionTextInput = optionItem.querySelector('.option-input');
                        
                        if (!optionTextInput || !optionTextInput.value.trim()) {
                            return; // Пропускаем пустые варианты
                        }
                        
                        question.Options.push({
                            Id: optionId || null,
                            Text: optionTextInput.value.trim(),
                            Order: optionOrder++
                        });
                    });
                    
                    // Добавляем вопрос только если у него есть варианты ответов (для типов с выбором)
                    // или если это текстовый вопрос
                    const needsOptions = ['SingleChoice', 'MultipleChoice', 'Dropdown', 'Scale', 'Rating'].includes(questionType);
                    if (!needsOptions || question.Options.length > 0) {
                        data.Questions.push(question);
                    }
                });
                
                return data;
            }
            
            // JS-функция для публикации
            function publishSurvey(surveyId) {
                if (confirm('Опубликовать эту форму? Она станет доступна по ссылке.')) {
                    // Сначала сохраняем данные формы
                    const formData = collectFormData();
                    
                    // Получаем токен из формы
                    var token = document.querySelector('input[name="__RequestVerificationToken"]')?.value || '';
                    
                    // Если токен не найден в форме, пытаемся получить из cookie
                    if (!token) {
                        var cookies = document.cookie.split(';');
                        for (var i = 0; i < cookies.length; i++) {
                            var cookie = cookies[i].trim();
                            if (cookie.startsWith('__RequestVerificationToken=')) {
                                token = cookie.substring('__RequestVerificationToken='.length);
                                break;
                            }
                        }
                    }
                    
                    if (!token) {
                        alert('Ошибка: не найден токен безопасности. Перезагрузите страницу и попробуйте снова.');
                        return;
                    }
                    
                    // Сохраняем данные перед публикацией
                    fetch('/api/surveys/save', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'RequestVerificationToken': token
                        },
                        credentials: 'include',
                        body: JSON.stringify(formData)
                    })
                    .then(async response => {
                        const contentType = response.headers.get('content-type');
                        if (contentType && contentType.includes('application/json')) {
                            const data = await response.json();
                            return { ok: response.ok, data: data };
                        } else {
                            const text = await response.text();
                            throw new Error(text || `Ошибка сохранения: ${response.status}`);
                        }
                    })
                    .then(saveResult => {
                        if (!saveResult.ok || !saveResult.data.Success) {
                            throw new Error(saveResult.data.Message || 'Ошибка при сохранении данных');
                        }
                        
                        // После успешного сохранения публикуем
                        return fetch(`/Survey/Publish/${surveyId}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                                'RequestVerificationToken': token
                            },
                            credentials: 'include',
                            body: '__RequestVerificationToken=' + encodeURIComponent(token)
                        });
                    })
                    .then(async response => {
                        const contentType = response.headers.get('content-type');
                        if (contentType && contentType.includes('application/json')) {
                            const data = await response.json();
                            return { ok: response.ok, status: response.status, data: data };
                        } else {
                            const text = await response.text();
                            console.error('Non-JSON response:', text);
                            return { ok: false, status: response.status, data: { success: false, message: `Ошибка ${response.status}: ${response.statusText}` } };
                        }
                    })
                    .then(result => {
                        if (result.ok && result.data.success) {
                            alert(result.data.message);
                            location.reload();
                        } else {
                            alert(result.data.message || 'Ошибка при публикации');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Ошибка при публикации опроса: ' + (error.message || 'Неизвестная ошибка'));
                    });
                }
            }

            // JS-функция для снятия с публикации
            function unpublishSurvey(surveyId) {
                if (confirm('Снять форму с публикации? Она больше не будет доступна по ссылке.')) {
                    // Получаем токен из формы
                    var token = document.querySelector('input[name="__RequestVerificationToken"]')?.value || '';
                    
                    // Если токен не найден в форме, пытаемся получить из cookie
                    if (!token) {
                        var cookies = document.cookie.split(';');
                        for (var i = 0; i < cookies.length; i++) {
                            var cookie = cookies[i].trim();
                            if (cookie.startsWith('__RequestVerificationToken=')) {
                                token = cookie.substring('__RequestVerificationToken='.length);
                                break;
                            }
                        }
                    }
                    
                    if (!token) {
                        alert('Ошибка: не найден токен безопасности. Перезагрузите страницу и попробуйте снова.');
                        return;
                    }
                    
                    fetch(`/Survey/Unpublish/${surveyId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'RequestVerificationToken': token
                        },
                        credentials: 'include', // Важно для отправки cookies
                        body: '__RequestVerificationToken=' + encodeURIComponent(token)
                    })
                    .then(async response => {
                        const contentType = response.headers.get('content-type');
                        if (contentType && contentType.includes('application/json')) {
                            const data = await response.json();
                            return { ok: response.ok, status: response.status, data: data };
                        } else {
                            const text = await response.text();
                            console.error('Non-JSON response:', text);
                            return { ok: false, status: response.status, data: { success: false, message: `Ошибка ${response.status}: ${response.statusText}` } };
                        }
                    })
                    .then(result => {
                        if (result.ok && result.data.success) {
                            alert(result.data.message);
                            location.reload();
                        } else {
                            alert(result.data.message || 'Ошибка при снятии с публикации');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Ошибка при снятии с публикации: ' + (error.message || 'Неизвестная ошибка'));
                    });
                }
            }
        </script>

        <script src="~/js/constructor.js" asp-append-version="true"></script>
    }
</body>