@model NovoyaHope.Models.ViewModels.SurveyResultsViewModel
@using NovoyaHope.Models
@using System.Linq
@using System.Text.Json

@{
    ViewData["Title"] = "–û—Ç–≤–µ—Ç—ã: " + Model.SurveyTitle;
    Layout = "_Layout";
}

<div class="container mt-4">
    <div class="results-header" style="background: white; padding: 30px; border-radius: 12px; box-shadow: 0 2px 8px rgba(46, 125, 50, 0.1); margin-bottom: 30px; border-top: 4px solid #2e7d32;">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div style="flex: 1;">
                <h1 style="color: #2e7d32; margin-bottom: 10px; font-weight: 600;">@Model.SurveyTitle</h1>
                <div style="display: flex; gap: 30px; color: #5f6368; margin-top: 15px;">
                    <div>
                        <strong style="color: #2e7d32;">@Model.TotalResponses</strong> –æ—Ç–≤–µ—Ç–æ–≤
                    </div>
                    <div>
                        –°–æ–∑–¥–∞–Ω–æ: @Model.CreationDate.ToString("dd.MM.yyyy")
                    </div>
                    <div>
                        <a asp-controller="Public" asp-action="ViewSurvey" asp-route-id="@Model.SurveyId" target="_blank" 
                           style="color: #2e7d32; text-decoration: underline;">üîó –û—Ç–∫—Ä—ã—Ç—å –æ–ø—Ä–æ—Å</a>
                    </div>
                </div>
            </div>
            @if (Model.TotalResponses > 0)
            {
                <div>
                    <a asp-action="ExportResults" asp-route-id="@Model.SurveyId" asp-route-format="csv" 
                       class="export-btn" 
                       style="background: #2e7d32; color: white; padding: 12px 24px; border-radius: 8px; text-decoration: none; display: inline-flex; align-items: center; gap: 8px; font-weight: 500; border: none; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 4px rgba(46, 125, 50, 0.2);">
                        üì• –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV
                    </a>
                </div>
            }
        </div>
    </div>

    @if (Model.TotalResponses == 0)
    {
        <div style="background: white; padding: 60px; border-radius: 12px; text-align: center; box-shadow: 0 2px 8px rgba(46, 125, 50, 0.1);">
            <div style="font-size: 4rem; margin-bottom: 20px;">üìä</div>
            <h3 style="color: #5f6368; margin-bottom: 10px;">–ü–æ–∫–∞ –Ω–µ—Ç –æ—Ç–≤–µ—Ç–æ–≤</h3>
            <p style="color: #5f6368;">–ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–∞—á–Ω—É—Ç –ø—Ä–æ—Ö–æ–¥–∏—Ç—å –≤–∞—à –æ–ø—Ä–æ—Å, —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å.</p>
        </div>
    }
    else
    {
        @foreach (var questionResult in Model.QuestionResults)
        {
            <div class="question-result-card" style="background: white; padding: 30px; border-radius: 12px; box-shadow: 0 2px 8px rgba(46, 125, 50, 0.1); margin-bottom: 25px;">
                <h3 style="color: #1a1a1a; margin-bottom: 20px; font-weight: 600; font-size: 1.2rem;">
                    @questionResult.Text
                </h3>

                @if (questionResult.Type == QuestionType.ShortText || questionResult.Type == QuestionType.ParagraphText)
                {
                    <!-- –¢–µ–∫—Å—Ç–æ–≤—ã–µ –æ—Ç–≤–µ—Ç—ã -->
                    <div class="text-answers">
                        @if (questionResult.TextAnswers != null && questionResult.TextAnswers.Any())
                        {
                            <div style="max-height: 400px; overflow-y: auto;">
                            @foreach (var textAnswer in questionResult.TextAnswers)
                            {
                                <div style="padding: 12px; margin-bottom: 10px; background: #f5faf5; border-left: 3px solid #4caf50; border-radius: 6px;">
                                    @textAnswer
                                </div>
                            }
                            </div>
                        }
                        else
                        {
                            <p style="color: #5f6368; font-style: italic;">–ù–µ—Ç –æ—Ç–≤–µ—Ç–æ–≤</p>
                        }
                    </div>
                }
                else if (questionResult.Type == QuestionType.SingleChoice || questionResult.Type == QuestionType.MultipleChoice)
                {
                    <!-- –û—Ç–≤–µ—Ç—ã —Å –≤—ã–±–æ—Ä–æ–º –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ -->
                    <div class="choice-results">
                        @if (questionResult.OptionTexts != null && questionResult.OptionTexts.Any())
                        {
                            var totalVotes = questionResult.OptionCounts.Values.Sum();
                            var labels = questionResult.OptionTexts.Select(o => o.Value).ToList();
                            var values = questionResult.OptionTexts.Select(o => questionResult.OptionCounts.ContainsKey(o.Key) ? questionResult.OptionCounts[o.Key] : 0).ToList();
                            var chartType = questionResult.Type == QuestionType.SingleChoice ? "pie" : "bar";
                            
                            <!-- –ì—Ä–∞—Ñ–∏–∫ -->
                            <div class="chart-container" style="margin-bottom: 30px; position: relative; height: 400px;">
                                <div data-chart-type="@chartType" 
                                     data-question-id="@questionResult.QuestionId"
                                     data-labels='@Html.Raw(JsonSerializer.Serialize(labels))'
                                     data-values='@Html.Raw(JsonSerializer.Serialize(values))'>
                                    <canvas id="chart-@questionResult.QuestionId"></canvas>
                                </div>
                            </div>
                            
                            <!-- –¢–µ–∫—Å—Ç–æ–≤–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ -->
                            @foreach (var option in questionResult.OptionTexts)
                            {
                                var count = questionResult.OptionCounts.ContainsKey(option.Key) ? questionResult.OptionCounts[option.Key] : 0;
                                var percentage = totalVotes > 0 ? (count * 100.0 / totalVotes) : 0;
                                
                                <div style="margin-bottom: 20px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                        <span style="font-weight: 500; color: #1a1a1a;">@option.Value</span>
                                        <span style="color: #2e7d32; font-weight: 600;">@count (@percentage.ToString("F1"))%</span>
                                    </div>
                                    <div style="background: #e0e0e0; border-radius: 8px; height: 30px; overflow: hidden; position: relative;">
                                        <div style="background: linear-gradient(90deg, #4caf50 0%, #81c784 100%); height: 100%; width: @percentage%; transition: width 0.5s; border-radius: 8px;"></div>
                                    </div>
                                </div>
                            }
                        }
                    </div>
                }
                else if (questionResult.Type == QuestionType.Scale)
                {
                    <!-- –®–∫–∞–ª–∞ -->
                    <div class="scale-results">
                        <div style="background: #f5faf5; padding: 20px; border-radius: 8px; margin-bottom: 20px; text-align: center;">
                            <div style="font-size: 2rem; color: #2e7d32; font-weight: 700;">@questionResult.AverageScore.ToString("F2")</div>
                            <div style="color: #5f6368; margin-top: 5px;">–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª</div>
                        </div>
                        
                        @if (questionResult.OptionTexts != null && questionResult.OptionTexts.Any())
                        {
                            var orderedOptions = questionResult.OptionTexts.OrderBy(o => o.Value).ToList();
                            var labels = orderedOptions.Select(o => o.Value).ToList();
                            var values = orderedOptions.Select(o => questionResult.OptionCounts.ContainsKey(o.Key) ? questionResult.OptionCounts[o.Key] : 0).ToList();
                            var totalVotes = questionResult.OptionCounts.Values.Sum();
                            
                            <!-- –ì—Ä–∞—Ñ–∏–∫ -->
                            <div class="chart-container" style="margin-bottom: 30px; position: relative; height: 400px;">
                                <div data-chart-type="line" 
                                     data-question-id="@questionResult.QuestionId"
                                     data-labels='@Html.Raw(JsonSerializer.Serialize(labels))'
                                     data-values='@Html.Raw(JsonSerializer.Serialize(values))'>
                                    <canvas id="chart-@questionResult.QuestionId"></canvas>
                                </div>
                            </div>
                            
                            <!-- –¢–µ–∫—Å—Ç–æ–≤–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ -->
                            @foreach (var option in orderedOptions)
                            {
                                var count = questionResult.OptionCounts.ContainsKey(option.Key) ? questionResult.OptionCounts[option.Key] : 0;
                                var percentage = totalVotes > 0 ? (count * 100.0 / totalVotes) : 0;
                                
                                <div style="margin-bottom: 15px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                                        <span style="font-weight: 500; color: #1a1a1a;">@option.Value</span>
                                        <span style="color: #2e7d32; font-weight: 600;">@count</span>
                                    </div>
                                    <div style="background: #e0e0e0; border-radius: 6px; height: 24px; overflow: hidden;">
                                        <div style="background: linear-gradient(90deg, #4caf50 0%, #81c784 100%); height: 100%; width: @percentage%; transition: width 0.5s; border-radius: 6px;"></div>
                                    </div>
                                </div>
                            }
                        }
                    </div>
                }
                else if (questionResult.Type == QuestionType.Rating)
                {
                    <!-- –†–µ–π—Ç–∏–Ω–≥ -->
                    <div class="rating-results">
                        <div style="background: #f5faf5; padding: 20px; border-radius: 8px; margin-bottom: 20px; text-align: center;">
                            <div style="font-size: 2rem; color: #2e7d32; font-weight: 700;">@questionResult.AverageScore.ToString("F2")</div>
                            <div style="color: #5f6368; margin-top: 5px;">–°—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞</div>
                        </div>
                        
                        @if (questionResult.OptionTexts != null && questionResult.OptionTexts.Any())
                        {
                            var orderedOptions = questionResult.OptionTexts.OrderBy(o => o.Value).ToList();
                            var labels = orderedOptions.Select(o => o.Value).ToList();
                            var values = orderedOptions.Select(o => questionResult.OptionCounts.ContainsKey(o.Key) ? questionResult.OptionCounts[o.Key] : 0).ToList();
                            var totalVotes = questionResult.OptionCounts.Values.Sum();
                            
                            <!-- –ì—Ä–∞—Ñ–∏–∫ -->
                            <div class="chart-container" style="margin-bottom: 30px; position: relative; height: 400px;">
                                <div data-chart-type="bar-rating" 
                                     data-question-id="@questionResult.QuestionId"
                                     data-labels='@Html.Raw(JsonSerializer.Serialize(labels))'
                                     data-values='@Html.Raw(JsonSerializer.Serialize(values))'>
                                    <canvas id="chart-@questionResult.QuestionId"></canvas>
                                </div>
                            </div>
                            
                            <!-- –¢–µ–∫—Å—Ç–æ–≤–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ -->
                            @foreach (var option in orderedOptions)
                            {
                                var count = questionResult.OptionCounts.ContainsKey(option.Key) ? questionResult.OptionCounts[option.Key] : 0;
                                var percentage = totalVotes > 0 ? (count * 100.0 / totalVotes) : 0;
                                
                                <div style="margin-bottom: 15px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                                        <span style="font-weight: 500; color: #1a1a1a;">@option.Value</span>
                                        <span style="color: #2e7d32; font-weight: 600;">@count (@percentage.ToString("F1"))%</span>
                                    </div>
                                    <div style="background: #e0e0e0; border-radius: 6px; height: 24px; overflow: hidden;">
                                        <div style="background: linear-gradient(90deg, #4caf50 0%, #81c784 100%); height: 100%; width: @percentage%; transition: width 0.5s; border-radius: 6px;"></div>
                                    </div>
                                </div>
                            }
                        }
                    </div>
                }
            </div>
        }
    }
</div>

<style>
    .question-result-card {
        transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .question-result-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(46, 125, 50, 0.15) !important;
    }
    
    .export-btn:hover {
        background: #1b5e20 !important;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(46, 125, 50, 0.3) !important;
    }
    
    .export-btn:active {
        transform: translateY(0);
        box-shadow: 0 1px 3px rgba(46, 125, 50, 0.2) !important;
    }
</style>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<!-- Analytics Script -->
<script src="~/js/analytics.js" asp-append-version="true"></script>

