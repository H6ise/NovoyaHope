# Документация взаимодействия с пользователем - NovoyaHope

## Содержание

1. [Обзор](#обзор)
2. [Типы пользователей и роли](#типы-пользователей-и-роли)
3. [Основные пользовательские сценарии](#основные-пользовательские-сценарии)
4. [Детальные пользовательские потоки](#детальные-пользовательские-потоки)
5. [Маршруты и навигация](#маршруты-и-навигация)
6. [Ограничения доступа](#ограничения-доступа)
7. [API эндпоинты](#api-эндпоинты)

---

## Обзор

NovoyaHope - это веб-платформа для создания, управления и прохождения опросов. Система поддерживает различные типы пользователей и предоставляет функциональность для создания опросов, прохождения опросов, управления шаблонами и административного управления.

### Основные функции

- ✅ Аутентификация и авторизация пользователей
- ✅ Создание и редактирование опросов (12 типов вопросов)
- ✅ Публикация опросов и управление ими
- ✅ Прохождение опубликованных опросов (публичный доступ)
- ✅ Просмотр результатов и статистики
- ✅ Управление шаблонами опросов
- ✅ Административная панель
- ✅ Управление профилем пользователя

---

## Типы пользователей и роли

### 1. Анонимный пользователь (Гость)

**Доступ:**
- Просмотр главной страницы
- Регистрация и вход в систему
- Прохождение опубликованных опросов (если они анонимные)
- Доступ к публичным страницам (About, Features, Help, etc.)

**Ограничения:**
- Не может создавать опросы
- Не может просматривать результаты
- Не может управлять опросами

### 2. Аутентифицированный пользователь (User)

**Роль:** `User`

**Доступ:**
- Все возможности анонимного пользователя
- Создание и редактирование своих опросов
- Публикация и управление своими опросами
- Просмотр результатов своих опросов
- Экспорт результатов в CSV
- Управление профилем
- Использование шаблонов
- Просмотр списка своих опросов

**Ограничения:**
- Не может редактировать чужие опросы
- Не может удалять чужие опросы
- Не имеет доступа к админ-панели

### 3. Администратор (Administrator)

**Роль:** `Administrator`

**Доступ:**
- Все возможности пользователя
- Административная панель
- Управление всеми пользователями
- Управление всеми опросами
- Управление шаблонами
- Просмотр статистики системы

**Особые возможности:**
- Удаление любых опросов
- Удаление пользователей
- Назначение и снятие ролей
- Публикация/снятие с публикации любых опросов

---

## Основные пользовательские сценарии

### Сценарий 1: Регистрация и вход в систему

**Актеры:** Гость → Пользователь

**Шаги:**

1. **Регистрация нового пользователя**
   - Пользователь переходит на главную страницу
   - Нажимает "Вход" в навигации
   - Выбирает "Регистрация" (или переходит на `/Account/Register`)
   - Заполняет форму:
     - Email (используется как имя пользователя)
     - Пароль (минимум 6 символов)
     - Подтверждение пароля
   - Нажимает "Зарегистрироваться"
   - Система автоматически создает пользователя с ролью "User"
   - Пользователь автоматически входит в систему
   - Перенаправление на главную страницу

2. **Вход существующего пользователя**
   - Пользователь переходит на `/Account/Login`
   - Вводит Email и пароль
   - Опционально: устанавливает "Запомнить меня"
   - Нажимает "Войти"
   - При успешном входе перенаправление на главную страницу или returnUrl

**Маршруты:**
- `GET /Account/Login` - страница входа
- `POST /Account/Login` - обработка входа
- `GET /Account/Register` - страница регистрации
- `POST /Account/Register` - обработка регистрации

---

### Сценарий 2: Создание опроса

**Актеры:** Аутентифицированный пользователь

**Шаги:**

1. **Начало создания опроса**
   - Пользователь переходит в "Мои опросы" (`/Survey/Index`)
   - Нажимает кнопку "Создать опрос"
   - Система создает новый опрос с заголовком "Новая форма"
   - Автоматическое перенаправление в конструктор (`/Survey/Edit/{id}`)

2. **Редактирование опроса в конструкторе**
   - Вкладка "Настройки":
     - Заголовок опроса
     - Описание опроса
     - Тип опроса (Poll или Questionnaire)
     - Настройки публикации (анонимный/не анонимный)
     - Дата окончания опроса
     - Настройки темы (цвета, шрифты, изображения)
     - Настройки теста (если включен режим теста)
   
   - Вкладка "Вопросы":
     - Добавление вопросов (кнопка "Добавить вопрос")
     - Выбор типа вопроса из 12 доступных:
       1. Текст (строка)
       2. Текст (абзац)
       3. Один из списка (радио)
       4. Несколько из списка (чекбоксы)
       5. Раскрывающийся список
       6. Загрузка файлов
       7. Шкала
       8. Оценка (звезды)
       9. Сетка флажков
       10. Сетка (множественный выбор)
       11. Дата
       12. Время
     - Редактирование текста вопроса
     - Настройка обязательности вопроса
     - Добавление вариантов ответов (для типов с выбором)
     - Установка порядка вопросов (drag & drop или изменение Order)
     - Дублирование вопросов
     - Удаление вопросов
   
   - Вкладка "Разделы":
     - Добавление разделов для группировки вопросов
     - Редактирование заголовка и описания раздела
     - Установка порядка разделов
   
   - Вкладка "Медиа":
     - Добавление изображений или видео
     - Привязка медиа к опросу или конкретному вопросу
     - Загрузка файлов или указание URL
   
   - Вкладка "Ответы":
     - Просмотр статистики ответов (если есть)
     - Графики и диаграммы
     - Экспорт результатов

3. **Автосохранение**
   - Конструктор автоматически сохраняет изменения через AJAX
   - Уведомления об успешном сохранении

4. **Публикация опроса**
   - Нажатие кнопки "Опубликовать"
   - Система проверяет наличие хотя бы одного вопроса
   - При успешной публикации генерируется публичная ссылка
   - Опрос становится доступным по `/Public/ViewSurvey/{id}`

**Маршруты:**
- `GET /Survey/Index` - список опросов пользователя
- `GET /Survey/Edit` или `GET /Survey/Edit/{id}` - конструктор
- `POST /api/surveys/save` - сохранение опроса (AJAX)
- `POST /Survey/Publish/{id}` - публикация опроса
- `POST /Survey/Unpublish/{id}` - снятие с публикации

**Ограничения:**
- Только создатель опроса может его редактировать
- Нельзя опубликовать опрос без вопросов

---

### Сценарий 3: Прохождение опроса

**Актеры:** Любой пользователь (анонимный или аутентифицированный)

**Шаги:**

1. **Доступ к опросу**
   - Пользователь получает ссылку на опрос (`/Public/ViewSurvey/{id}`)
   - Переходит по ссылке
   - Система проверяет:
     - Существует ли опрос
     - Опубликован ли опрос
     - Не истекла ли дата окончания (если указана)

2. **Заполнение опроса**
   - Отображение заголовка, описания и настроек темы опроса
   - Отображение разделов (если есть)
   - Отображение медиа-элементов (если есть)
   - Отображение вопросов по порядку
   - Заполнение ответов:
     - Текстовые поля для текстовых вопросов
     - Радио/чекбоксы для вопросов с выбором
     - Файлы для загрузки
     - Выбор даты/времени
   - Валидация обязательных вопросов

3. **Отправка ответа**
   - Нажатие кнопки "Отправить"
   - Валидация всех обязательных вопросов
   - Если валидация успешна:
     - Создание записи SurveyResponse
     - Сохранение всех ответов (UserAnswer)
     - Определение пользователя (если опрос не анонимный)
     - Перенаправление на страницу благодарности (`/Public/ThankYou`)
   - Если валидация не пройдена:
     - Отображение ошибок
     - Возможность исправить ответы

**Маршруты:**
- `GET /Public/ViewSurvey/{id}` - просмотр опроса
- `POST /Public/SubmitResponse` - отправка ответов

**Особенности:**
- Анонимные опросы не требуют авторизации
- Неанонимные опросы сохраняют связь с пользователем (если авторизован)
- Один пользователь может пройти один опрос несколько раз (если не реализовано ограничение)

---

### Сценарий 4: Просмотр результатов опроса

**Актеры:** Создатель опроса, Администратор

**Шаги:**

1. **Доступ к результатам**
   - Пользователь переходит в "Мои опросы"
   - Выбирает опрос из списка
   - Нажимает "Результаты" в меню опроса
   - Или переходит напрямую на `/Survey/Results/{id}`

2. **Просмотр статистики**
   - Общее количество ответов
   - Дата создания опроса
   - Результаты по каждому вопросу:
     - Для текстовых вопросов: список всех ответов
     - Для вопросов с выбором: количество ответов по каждому варианту
     - Для шкалы: среднее значение
   - Визуализация данных (графики, диаграммы)

3. **Экспорт результатов**
   - Нажатие кнопки "Экспорт"
   - Выбор формата (CSV)
   - Загрузка файла с результатами

**Маршруты:**
- `GET /Survey/Results/{id}` - просмотр результатов
- `GET /Survey/ExportResults/{id}?format=csv` - экспорт результатов

**Ограничения:**
- Только создатель опроса может просматривать результаты
- Администратор может просматривать результаты всех опросов

---

### Сценарий 5: Управление профилем

**Актеры:** Аутентифицированный пользователь

**Шаги:**

1. **Просмотр профиля**
   - Клик на аватар/имя в навигации
   - Выбор "Профиль" из dropdown меню
   - Переход на `/Account/Profile`

2. **Редактирование профиля**
   - Изменение имени
   - Изменение фамилии
   - Изменение email
   - Изменение номера телефона
   - Настройка видимости телефона
   - Загрузка/изменение фото профиля
   - Сохранение изменений

3. **Смена пароля**
   - Переход в настройки профиля
   - Ввод текущего пароля
   - Ввод нового пароля
   - Подтверждение нового пароля
   - Сохранение

**Маршруты:**
- `GET /Account/Profile` - просмотр/редактирование профиля
- `POST /Account/Profile` - сохранение профиля
- `POST /Account/ChangePassword` - смена пароля
- `GET /Account/Settings` - настройки

---

### Сценарий 6: Использование шаблонов

**Актеры:** Аутентифицированный пользователь

**Шаги:**

1. **Просмотр шаблонов**
   - Переход в "Шаблоны" (`/Survey/Templates`)
   - Просмотр доступных шаблонов опросов

2. **Создание опроса из шаблона**
   - Выбор шаблона
   - Нажатие "Использовать шаблон"
   - Система создает новый опрос на основе шаблона
   - Автоматическое перенаправление в конструктор
   - Возможность редактирования перед публикацией

**Маршруты:**
- `GET /Survey/Templates` - список шаблонов
- `POST /Survey/UseTemplate/{id}` - создание опроса из шаблона

---

### Сценарий 7: Административное управление

**Актеры:** Администратор

**Шаги:**

1. **Доступ к админ-панели**
   - Вход в систему с ролью Administrator
   - Появление пункта "Админ-панель" в навигации
   - Переход на `/Admin/Index`

2. **Просмотр статистики (Dashboard)**
   - Общее количество пользователей
   - Общее количество опросов
   - Общее количество шаблонов
   - Общее количество ответов
   - Количество опубликованных опросов
   - Последние 5 опросов
   - Последние 5 пользователей

3. **Управление пользователями**
   - Переход на `/Admin/UserManagement`
   - Поиск пользователей
   - Просмотр списка пользователей с пагинацией
   - Возможности:
     - Просмотр информации о пользователе
     - Удаление пользователя
     - Назначение/снятие ролей
     - Просмотр статистики пользователя (количество опросов, ответов)

4. **Управление опросами**
   - Переход на `/Admin/Surveys`
   - Поиск опросов
   - Просмотр всех опросов системы
   - Возможности:
     - Публикация/снятие с публикации
     - Удаление опроса
     - Просмотр создателя опроса

5. **Управление шаблонами**
   - Переход на `/Admin/TemplateManager`
   - Поиск шаблонов
   - Просмотр всех шаблонов
   - Возможность удаления шаблонов

**Маршруты:**
- `GET /Admin/Index` - главная страница админ-панели
- `GET /Admin/UserManagement` - управление пользователями
- `POST /Admin/DeleteUser/{id}` - удаление пользователя
- `POST /Admin/ToggleUserRole` - изменение роли пользователя
- `GET /Admin/Surveys` - управление опросами
- `POST /Admin/DeleteSurvey/{id}` - удаление опроса
- `POST /Admin/ToggleSurveyPublish/{id}` - публикация/снятие опроса
- `GET /Admin/TemplateManager` - управление шаблонами
- `POST /Admin/DeleteTemplate/{id}` - удаление шаблона

**Ограничения:**
- Только пользователи с ролью "Administrator" имеют доступ
- Нельзя удалить последнего администратора
- Нельзя снять роль администратора у последнего администратора

---

## Детальные пользовательские потоки

### Поток: Создание и публикация опроса

```
[Начало]
    |
    v
[Вход в систему] ──┐
    |              │ (если не авторизован)
    v              │
[Главная]          │
    |              │
    v              │
[Мои опросы]       │
    |              │
    v              │
[Создать опрос]    │
    |              │
    v              │
[Конструктор] ─────┘
    |
    ├─→ [Настройки] → Заполнение метаданных
    |
    ├─→ [Вопросы] → Добавление вопросов
    |                 ├─→ Выбор типа вопроса
    |                 ├─→ Заполнение текста
    |                 └─→ Добавление вариантов (если нужно)
    |
    ├─→ [Разделы] → Группировка вопросов (опционально)
    |
    ├─→ [Медиа] → Добавление изображений/видео (опционально)
    |
    └─→ [Ответы] → Просмотр статистики (после публикации)
    |
    v
[Автосохранение]
    |
    v
[Публикация] → Проверка наличия вопросов
    |
    ├─→ [Успех] → Получение публичной ссылки
    |
    └─→ [Ошибка] → Возврат в конструктор
    |
    v
[Конец]
```

### Поток: Прохождение опроса

```
[Начало]
    |
    v
[Получение ссылки на опрос]
    |
    v
[Переход по ссылке] → Проверка существования и публикации
    |
    ├─→ [Опрос не найден] → Страница 404
    |
    ├─→ [Опрос не опубликован] → Страница 404
    |
    └─→ [Успех]
         |
         v
[Отображение опроса]
    |
    ├─→ Заголовок и описание
    ├─→ Разделы (если есть)
    ├─→ Медиа (если есть)
    └─→ Вопросы
         |
         v
[Заполнение ответов]
    |
    ├─→ Текстовые вопросы
    ├─→ Вопросы с выбором
    ├─→ Загрузка файлов
    └─→ Дата/время
    |
    v
[Нажатие "Отправить"]
    |
    v
[Валидация]
    |
    ├─→ [Ошибки] → Отображение ошибок → Возврат к форме
    |
    └─→ [Успех]
         |
         ├─→ Определение пользователя (если не анонимный)
         ├─→ Сохранение ответов
         └─→ Страница благодарности
         |
         v
[Конец]
```

---

## Маршруты и навигация

### Публичные маршруты (доступны всем)

| Маршрут | Описание | Контроллер |
|---------|----------|------------|
| `GET /` | Главная страница | Home/Index |
| `GET /Home/About` | О нас | Home/About |
| `GET /Home/Features` | Возможности | Home/Features |
| `GET /Home/Pricing` | Тарифы | Home/Pricing |
| `GET /Home/Help` | Помощь | Home/Help |
| `GET /Home/Documentation` | Документация | Home/Documentation |
| `GET /Home/Blog` | Блог | Home/Blog |
| `GET /Home/Contact` | Контакты | Home/Contact |
| `GET /Home/Privacy` | Политика конфиденциальности | Home/Privacy |
| `GET /Home/Terms` | Условия использования | Home/Terms |
| `GET /Home/Cookies` | Cookie | Home/Cookies |
| `GET /Account/Login` | Вход | Account/Login |
| `POST /Account/Login` | Обработка входа | Account/Login |
| `GET /Account/Register` | Регистрация | Account/Register |
| `POST /Account/Register` | Обработка регистрации | Account/Register |
| `GET /Public/ViewSurvey/{id}` | Просмотр опроса | Public/ViewSurvey |
| `POST /Public/SubmitResponse` | Отправка ответов | Public/SubmitResponse |
| `GET /Public/ThankYou` | Страница благодарности | Public/ThankYou |

### Приватные маршруты (требуют авторизации)

| Маршрут | Описание | Контроллер | Роль |
|---------|----------|------------|------|
| `GET /Survey/Index` | Мои опросы | Survey/Index | User |
| `GET /Survey/Edit/{id?}` | Конструктор опросов | Survey/Edit | User |
| `POST /api/surveys/save` | Сохранение опроса (AJAX) | Survey/SaveSurvey | User |
| `POST /Survey/Publish/{id}` | Публикация опроса | Survey/Publish | User |
| `POST /Survey/Unpublish/{id}` | Снятие с публикации | Survey/Unpublish | User |
| `GET /Survey/Preview/{id}` | Предпросмотр опроса | Survey/Preview | User |
| `GET /Survey/Results/{id}` | Результаты опроса | Survey/Results | User |
| `GET /Survey/ExportResults/{id}` | Экспорт результатов | Survey/ExportResults | User |
| `POST /Survey/Delete/{id}` | Удаление опроса | Survey/Delete | User |
| `GET /Survey/Templates` | Шаблоны опросов | Survey/Templates | User |
| `POST /Survey/UseTemplate/{id}` | Использование шаблона | Survey/UseTemplate | User |
| `POST /Account/Logout` | Выход | Account/Logout | User |
| `GET /Account/Profile` | Профиль | Account/Profile | User |
| `POST /Account/Profile` | Сохранение профиля | Account/Profile | User |
| `POST /Account/ChangePassword` | Смена пароля | Account/ChangePassword | User |
| `GET /Account/Settings` | Настройки | Account/Settings | User |

### Административные маршруты (требуют роль Administrator)

| Маршрут | Описание | Контроллер | Роль |
|---------|----------|------------|------|
| `GET /Admin/Index` | Админ-панель (Dashboard) | Admin/Index | Administrator |
| `GET /Admin/UserManagement` | Управление пользователями | Admin/UserManagement | Administrator |
| `POST /Admin/DeleteUser/{id}` | Удаление пользователя | Admin/DeleteUser | Administrator |
| `POST /Admin/ToggleUserRole` | Изменение роли | Admin/ToggleUserRole | Administrator |
| `GET /Admin/Surveys` | Управление опросами | Admin/Surveys | Administrator |
| `POST /Admin/DeleteSurvey/{id}` | Удаление опроса | Admin/DeleteSurvey | Administrator |
| `POST /Admin/ToggleSurveyPublish/{id}` | Публикация/снятие опроса | Admin/ToggleSurveyPublish | Administrator |
| `GET /Admin/TemplateManager` | Управление шаблонами | Admin/TemplateManager | Administrator |
| `POST /Admin/DeleteTemplate/{id}` | Удаление шаблона | Admin/DeleteTemplate | Administrator |

### Структура навигации

#### Для анонимных пользователей:
```
[Logo] Главная | [Вход] [Регистрация]
```

#### Для авторизованных пользователей:
```
[Logo] Главная | Мои опросы | Шаблоны | [Профиль ▼]
                                                ├─ Профиль
                                                ├─ Настройки
                                                └─ Выход
```

#### Для администраторов:
```
[Logo] Главная | Мои опросы | Шаблоны | Админ-панель | [Профиль ▼]
                                                           ├─ Профиль
                                                           ├─ Настройки
                                                           └─ Выход
```

---

## Ограничения доступа

### Глобальная политика авторизации

По умолчанию все маршруты требуют авторизации (настроено в `Program.cs`):
```csharp
var policy = new AuthorizationPolicyBuilder()
    .RequireAuthenticatedUser()
    .Build();
```

### Исключения (AllowAnonymous)

Следующие контроллеры/действия доступны без авторизации:
- `HomeController` - все действия (публичные страницы)
- `AccountController` - Login, Register (использует `[AllowAnonymous]`)
- `PublicController` - ViewSurvey, SubmitResponse, ThankYou (использует `[AllowAnonymous]`)

### Проверка прав доступа

1. **Редактирование опроса**
   - Проверка: `survey.CreatorId == currentUser.Id`
   - Ошибка: `NotFound()` если права нет

2. **Удаление опроса**
   - Проверка: `survey.CreatorId == currentUser.Id`
   - Или: роль Administrator

3. **Просмотр результатов**
   - Проверка: `survey.CreatorId == currentUser.Id`
   - Или: роль Administrator

4. **Административные функции**
   - Проверка: `[Authorize(Roles = "Administrator")]`
   - Ошибка: `Forbid()` если роль нет

---

## API эндпоинты

### AJAX эндпоинты (JSON)

#### Сохранение опроса
```
POST /api/surveys/save
Content-Type: application/json

Request Body:
{
    "id": 1,  // nullable, для нового опроса не указывается
    "title": "Название опроса",
    "description": "Описание",
    "questions": [...],
    "sections": [...],
    "media": [...]
}

Response:
{
    "success": true,
    "surveyId": 1,
    "message": "Сохранено"
}
```

#### Публикация опроса
```
POST /survey/publish/{id}

Response:
{
    "success": true,
    "message": "Опросник успешно опубликован!",
    "publicUrl": "https://domain.com/Public/ViewSurvey/1"
}
```

#### Снятие с публикации
```
POST /survey/unpublish/{id}

Response:
{
    "success": true,
    "message": "Опросник снят с публикации."
}
```

---

## Версия документации

- **Версия**: 1.0
- **Дата**: 2025
- **Автор**: NovoyaHope Development Team
- **Последнее обновление**: Соответствует коду на момент создания документации

---

## Примечания

### Особенности реализации

1. **Автосохранение**: Конструктор автоматически сохраняет изменения через AJAX при изменении данных.

2. **Валидация**: Клиентская и серверная валидация форм обеспечивают корректность данных.

3. **Безопасность**: Использование Anti-Forgery токенов для защиты от CSRF-атак.

4. **Производительность**: Пагинация для больших списков, оптимизация запросов к базе данных.

5. **UX**: Интуитивная навигация, понятные сообщения об ошибках, визуальная обратная связь.

### Будущие улучшения

- Ограничение количества прохождений опроса одним пользователем
- Возможность редактирования ответов до публикации опроса
- Уведомления о новых ответах
- Совместное редактирование опросов
- Версионирование опросов

