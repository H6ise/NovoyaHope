# Документация серверной логики - NovoyaHope

## Содержание

1. [Обзор архитектуры](#обзор-архитектуры)
2. [Контроллеры (Controllers)](#контроллеры-controllers)
3. [Сервисы (Services)](#сервисы-services)
4. [Вспомогательные классы (Helpers)](#вспомогательные-классы-helpers)
5. [Классы данных (Data)](#классы-данных-data)
6. [Схема взаимодействия](#схема-взаимодействия)
7. [Разделение ответственности](#разделение-ответственности)

---

## Обзор архитектуры

Серверная логика в проекте NovoyaHope организована по принципу многослойной архитектуры (Layered Architecture) с разделением на уровни:

```
┌─────────────────────────────────────┐
│         Controllers                 │ ← Обработка HTTP запросов
│    (Презентационный слой)           │
└─────────────┬───────────────────────┘
              │
              ▼
┌─────────────────────────────────────┐
│          Services                   │ ← Бизнес-логика
│      (Слой бизнес-логики)           │
└─────────────┬───────────────────────┘
              │
              ▼
┌─────────────────────────────────────┐
│      ApplicationDbContext           │ ← Доступ к данным
│        (Слой данных)                │
└─────────────────────────────────────┘
              │
              ▼
┌─────────────────────────────────────┐
│         Database                    │ ← База данных
└─────────────────────────────────────┘
```

---

## Контроллеры (Controllers)

Контроллеры отвечают за обработку HTTP-запросов, валидацию входных данных, координацию вызовов сервисов и формирование ответов.

### 1. AccountController

**Расположение**: `Controllers/AccountController.cs`  
**Назначение**: Управление аутентификацией и профилями пользователей

**Основные методы и логика:**

#### Вход в систему
```csharp
public async Task<IActionResult> Login(LoginViewModel model, string returnUrl = null)
```
- **Логика**: 
  - Поиск пользователя по Email
  - Проверка пароля через SignInManager
  - Установка cookie аутентификации
  - Перенаправление на returnUrl или главную страницу

#### Регистрация
```csharp
public async Task<IActionResult> Register(RegisterViewModel model, string returnUrl = null)
```
- **Логика**:
  - Создание нового пользователя через UserManager
  - Назначение роли "User" по умолчанию
  - Автоматический вход после регистрации
  - Обработка ошибок регистрации

#### Управление профилем
```csharp
public async Task<IActionResult> Profile(ProfileViewModel model)
```
- **Логика**:
  - Обновление данных профиля (имя, фамилия, телефон)
  - Обработка загрузки фото профиля через ImageHelper
  - Обновление Email и UserName
  - Удаление старого фото при загрузке нового

#### Смена пароля
```csharp
public async Task<IActionResult> ChangePassword(ChangePasswordViewModel model)
```
- **Логика**:
  - Проверка текущего пароля
  - Установка нового пароля
  - Обновление сессии после смены пароля

**Зависимости:**
- `UserManager<ApplicationUser>` - управление пользователями
- `SignInManager<ApplicationUser>` - управление входом
- `RoleManager<IdentityRole>` - управление ролями
- `IWebHostEnvironment` - доступ к файловой системе
- `ImageHelper` - работа с изображениями

---

### 2. SurveyController

**Расположение**: `Controllers/SurveyController.cs`  
**Назначение**: Управление опросами и их созданием

**Основные методы и логика:**

#### Список опросов пользователя
```csharp
public async Task<IActionResult> Index()
```
- **Логика**:
  - Получение всех опросов текущего пользователя
  - Сортировка по дате создания (новые первыми)
  - Передача в представление для отображения

#### Редактирование/создание опроса
```csharp
public async Task<IActionResult> Edit(int? id)
```
- **Логика**:
  - Если `id == null`: создание нового опроса
  - Если `id != null`: загрузка существующего опроса
  - Проверка прав доступа (только создатель может редактировать)
  - Подготовка данных для конструктора:
    - Вопросы с вариантами ответов
    - Разделы
    - Медиа-элементы
    - Данные результатов (если есть ответы)
  - Маппинг в ViewModel для конструктора

#### Сохранение опроса (AJAX)
```csharp
[HttpPost]
[Route("api/surveys/save")]
public async Task<IActionResult> SaveSurvey([FromBody] SaveSurveyViewModel model)
```
- **Логика**:
  - Валидация модели
  - Проверка авторизации пользователя
  - Вызов `SurveyService.SaveSurveyAsync()` для сохранения
  - Обработка файлов медиа через ImageHelper
  - Возврат JSON ответа (успех/ошибка)

#### Публикация опроса
```csharp
public async Task<IActionResult> Publish(int id)
```
- **Логика**:
  - Проверка существования опроса
  - Проверка прав доступа
  - Проверка наличия хотя бы одного вопроса
  - Установка `IsPublished = true`
  - Возврат публичной ссылки

#### Просмотр результатов
```csharp
public async Task<IActionResult> Results(int id)
```
- **Логика**:
  - Загрузка опроса с ответами
  - Проверка прав доступа
  - Агрегация данных по каждому вопросу:
    - Для текстовых: список всех ответов
    - Для вопросов с выбором: подсчет ответов по вариантам
    - Для шкалы: вычисление среднего значения
  - Формирование ViewModel с результатами

#### Экспорт результатов
```csharp
public async Task<IActionResult> ExportResults(int id, string format = "csv")
```
- **Логика**:
  - Загрузка опроса с ответами
  - Формирование CSV файла:
    - Заголовки: ID ответа, Дата, Email, Вопросы
    - Данные: все ответы построчно
  - Экранирование специальных символов CSV
  - Возврат файла для скачивания

#### Удаление опроса
```csharp
public async Task<IActionResult> Delete(int id)
```
- **Логика**:
  - Загрузка опроса со всеми связанными данными
  - Проверка прав доступа
  - Каскадное удаление (настроено в ApplicationDbContext)
  - Логирование ошибок

#### Использование шаблона
```csharp
public async Task<IActionResult> UseTemplate(int id)
```
- **Логика**:
  - Загрузка шаблона с вопросами и вариантами
  - Создание нового опроса на основе шаблона
  - Копирование всех вопросов и вариантов ответов
  - Перенаправление в конструктор нового опроса

**Зависимости:**
- `ApplicationDbContext` - доступ к базе данных
- `UserManager<ApplicationUser>` - получение текущего пользователя
- `ISurveyService` - бизнес-логика сохранения опросов
- `ImageHelper` - обработка медиа-файлов
- `ILogger` - логирование

---

### 3. PublicController

**Расположение**: `Controllers/PublicController.cs`  
**Назначение**: Публичный доступ к опросам (без авторизации)

**Основные методы и логика:**

#### Просмотр опроса
```csharp
public async Task<IActionResult> ViewSurvey(int id)
```
- **Логика**:
  - Загрузка опроса с вопросами и вариантами
  - Проверка: опрос существует и опубликован
  - Применение настроек темы опроса
  - Формирование ViewModel для отображения
  - Сортировка элементов по Order

#### Отправка ответов
```csharp
[HttpPost]
public async Task<IActionResult> SubmitResponse(int SurveyId, IFormCollection form)
```
- **Логика**:
  - Парсинг данных формы в модель `SubmitResponseViewModel`
  - Проверка существования и публикации опроса
  - Определение пользователя (если опрос не анонимный)
  - Создание записи `SurveyResponse`
  - Обработка ответов по каждому вопросу:
    - Валидация обязательных вопросов
    - Для текстовых: сохранение в `TextAnswer`
    - Для вопросов с выбором: сохранение в `SelectedOptionId`
    - Для множественного выбора: создание нескольких записей `UserAnswer`
  - Сохранение всех ответов в транзакции
  - Перенаправление на страницу благодарности

**Зависимости:**
- `ApplicationDbContext` - доступ к базе данных
- `UserManager<ApplicationUser>` - получение пользователя (опционально)

---

### 4. AdminController

**Расположение**: `Controllers/AdminController.cs`  
**Назначение**: Административное управление системой

**Основные методы и логика:**

#### Dashboard (Главная страница)
```csharp
public async Task<IActionResult> Index()
```
- **Логика**:
  - Подсчет общей статистики:
    - Количество пользователей
    - Количество опросов
    - Количество шаблонов
    - Количество ответов
    - Количество опубликованных опросов
  - Получение последних 5 опросов
  - Получение последних 5 пользователей
  - Формирование ViewModel для dashboard

#### Управление пользователями
```csharp
public async Task<IActionResult> UserManagement(string searchTerm = "", int page = 1, int pageSize = 20)
```
- **Логика**:
  - Поиск пользователей по Email, имени, фамилии
  - Пагинация результатов
  - Получение ролей каждого пользователя
  - Подсчет статистики (количество опросов, ответов)
  - Формирование списка для отображения

#### Удаление пользователя
```csharp
public async Task<IActionResult> DeleteUser(string id)
```
- **Логика**:
  - Проверка существования пользователя
  - Проверка: не является ли последним администратором
  - Удаление пользователя через UserManager

#### Изменение роли пользователя
```csharp
public async Task<IActionResult> ToggleUserRole(string userId, string roleName)
```
- **Логика**:
  - Проверка существования пользователя
  - Если роль есть: удаление роли
  - Если роли нет: добавление роли
  - Защита от удаления роли администратора у последнего администратора

#### Управление опросами
```csharp
public async Task<IActionResult> Surveys(string searchTerm = "", int page = 1, int pageSize = 20)
```
- **Логика**:
  - Поиск опросов по названию/описанию
  - Пагинация
  - Загрузка создателя опроса
  - Подсчет количества ответов и вопросов

#### Управление шаблонами
```csharp
public async Task<IActionResult> TemplateManager(string searchTerm = "", int page = 1, int pageSize = 20)
```
- **Логика**:
  - Поиск шаблонов
  - Пагинация
  - Подсчет количества вопросов в шаблоне

**Зависимости:**
- `ApplicationDbContext` - доступ к базе данных
- `UserManager<ApplicationUser>` - управление пользователями
- `RoleManager<IdentityRole>` - управление ролями

---

### 5. HomeController

**Расположение**: `Controllers/HomeController.cs`  
**Назначение**: Публичные страницы и главная страница

**Основные методы и логика:**

#### Главная страница
```csharp
public async Task<IActionResult> Index()
```
- **Логика**:
  - Получение последних 5 шаблонов для превью
  - Формирование ViewModel для landing page

#### Остальные методы
- `About()`, `Features()`, `Pricing()`, `Help()`, `Documentation()`, `Blog()`, `Contact()`, `Privacy()`, `Terms()`, `Cookies()`
- **Логика**: Простое возвращение представлений (статичные страницы)

**Зависимости:**
- `ApplicationDbContext` - для получения шаблонов на главной странице

---

## Сервисы (Services)

Сервисы содержат бизнес-логику приложения, инкапсулируя операции с данными и бизнес-правила.

### SurveyService

**Расположение**: `Services/SurveyService.cs`  
**Интерфейс**: `Services/ISurveyService.cs`  
**Регистрация**: `AddScoped<ISurveyService, SurveyService>()` в `Program.cs`

**Назначение**: Бизнес-логика работы с опросами

#### Основные методы:

##### Сохранение/обновление опроса
```csharp
public async Task<int> SaveSurveyAsync(SaveSurveyViewModel model, string userId)
```

**Сложная логика синхронизации:**

1. **Определение операции**:
   - Если `model.Id.HasValue && model.Id.Value > 0` → Обновление
   - Иначе → Создание

2. **Обновление метаданных опроса**:
   - Заголовок, описание, тип
   - Настройки публикации и анонимности
   - Настройки теста (если включен)
   - Настройки темы

3. **Синхронизация вопросов**:
   - Определение вопросов для удаления (есть в БД, но нет в модели)
   - Удаление неиспользуемых вопросов
   - Обновление существующих вопросов
   - Добавление новых вопросов
   - Для каждого вопроса:
     - Обновление текста, типа, порядка, обязательности
     - Синхронизация вариантов ответов:
       - Удаление вариантов, которых нет в модели
       - Обновление существующих вариантов
       - Добавление новых вариантов

4. **Синхронизация разделов**:
   - Удаление удаленных разделов
   - Обновление существующих
   - Добавление новых

5. **Синхронизация медиа**:
   - Удаление удаленных медиа
   - Обновление существующих
   - Добавление новых

6. **Сохранение изменений** в базу данных

**Особенности:**
- Каскадное удаление настроено на уровне EF Core
- Использование транзакций для целостности данных
- Проверка прав доступа (только создатель может изменять)

##### Получение опроса для редактирования
```csharp
public async Task<SaveSurveyViewModel> GetSurveyForEditAsync(int surveyId, string userId)
```

**Логика:**
- Загрузка опроса с включенными данными (Include)
- Проверка прав доступа
- Маппинг из модели в ViewModel
- Сортировка элементов по Order

##### Изменение статуса публикации
```csharp
public async Task<bool> ChangePublicationStatusAsync(int surveyId, string userId, bool isPublished)
```

**Логика:**
- Проверка существования опроса и прав доступа
- Если публикация: проверка валидности опроса
- Установка статуса публикации

##### Проверка валидности для публикации
```csharp
public async Task<bool> IsSurveyValidForPublishingAsync(int surveyId, string userId)
```

**Логика:**
- Проверка наличия хотя бы одного вопроса
- Проверка прав доступа

##### Удаление опроса
```csharp
public async Task<bool> DeleteSurveyAsync(int surveyId, string userId)
```

**Логика:**
- Проверка прав доступа
- Удаление опроса (каскадное удаление настроено в ApplicationDbContext)

**Зависимости:**
- `ApplicationDbContext` - доступ к базе данных

---

## Вспомогательные классы (Helpers)

Вспомогательные классы содержат переиспользуемую функциональность для работы с файлами, валидацией и другими задачами.

### ImageHelper

**Расположение**: `Helpers/ImageHelper.cs`  
**Тип**: `static class`

**Назначение**: Работа с изображениями (валидация, сохранение, удаление)

#### Основные методы:

##### Валидация изображения
```csharp
public static bool IsValidImage(IFormFile file)
```

**Логика:**
- Проверка наличия файла
- Проверка размера (максимум 5 МБ)
- Проверка расширения файла (.jpg, .jpeg, .png, .gif, .webp, .bmp)
- Проверка MIME типа

##### Сохранение изображения профиля
```csharp
public static async Task<string> SaveProfileImageAsync(IFormFile file, string userId, string webRootPath)
```

**Логика:**
- Валидация изображения
- Создание директории `uploads/profiles` (если не существует)
- Генерация уникального имени файла (`{userId}_{Guid}.{extension}`)
- Сохранение файла на диск
- Возврат относительного пути к файлу

##### Сохранение медиа-изображения для опроса
```csharp
public static async Task<string> SaveMediaImageAsync(IFormFile file, int surveyId, string webRootPath)
```

**Логика:**
- Аналогично сохранению профиля
- Путь: `uploads/surveys/{surveyId}/media/{Guid}.{extension}`

##### Удаление изображения
```csharp
public static void DeleteProfileImage(string imagePath, string webRootPath)
```

**Логика:**
- Проверка существования файла
- Удаление файла с диска
- Обработка ошибок (не прерывает выполнение)

##### Форматирование размера файла
```csharp
public static string FormatFileSize(long bytes)
```

**Логика:**
- Конвертация байтов в читаемый формат (Б, КБ, МБ, ГБ)

---

### ValidationHelper

**Расположение**: `Helpers/ValidationHelper.cs`  
**Тип**: `static class`

**Назначение**: Валидация данных и санитизация строк

#### Основные методы:

##### Валидация Email
```csharp
public static bool IsValidEmail(string email)
```

**Логика:**
- Регулярное выражение для проверки формата email
- Проверка на null/пустоту

##### Валидация телефона
```csharp
public static bool IsValidPhone(string phone)
```

**Логика:**
- Удаление всех нецифровых символов кроме +
- Проверка длины (10-15 цифр)

##### Форматирование телефона
```csharp
public static string FormatPhone(string phone)
```

**Логика:**
- Нормализация российских номеров (8 → +7)
- Форматирование: +7 (999) 123-45-67

##### Валидация надежности пароля
```csharp
public static (bool IsValid, string Message) ValidatePasswordStrength(string password)
```

**Логика:**
- Проверка минимальной длины (6 символов)
- Проверка наличия строчных букв
- Проверка наличия заглавных букв
- Проверка наличия цифр
- Возврат результата с сообщением

##### Валидация имени/фамилии
```csharp
public static bool IsValidName(string name)
```

**Логика:**
- Проверка длины (максимум 50 символов)
- Разрешены только буквы (русские и английские), пробелы и дефисы
- Имя необязательно (может быть пустым)

##### Санитизация строки
```csharp
public static string SanitizeString(string input)
```

**Логика:**
- Удаление HTML тегов
- Удаление опасных символов (<, >, ", ')
- Обрезка пробелов

##### Проверка длины строки
```csharp
public static bool IsValidLength(string input, int minLength, int maxLength)
```

**Логика:**
- Проверка соответствия диапазону длины

##### Проверка на недопустимые символы
```csharp
public static bool ContainsInvalidCharacters(string input)
```

**Логика:**
- Проверка наличия управляющих символов (ASCII 0-31, 127)

---

## Классы данных (Data)

### ApplicationDbContext

**Расположение**: `Data/ApplicationDbContext.cs`  
**Тип**: `class : IdentityDbContext<ApplicationUser>`

**Назначение**: Конфигурация Entity Framework и доступ к базе данных

**Серверная логика:**

#### Конфигурация схемы базы данных
```csharp
protected override void OnModelCreating(ModelBuilder builder)
```

**Логика:**
1. **Настройка Identity таблиц**:
   - Переименование таблиц в схему "Identity"
   - Настройка имен таблиц

2. **Настройка каскадных удалений**:
   - При удалении Survey → удаляются Questions и SurveyResponses
   - При удалении Question → удаляются AnswerOptions
   - При удалении SurveyResponse → удаляются UserAnswers
   - При удалении Survey → удаляются Sections и Media
   - При удалении Question → Media.QuestionId становится NULL

3. **Настройка связей**:
   - Survey → ApplicationUser (Creator) - Restrict удаление
   - Survey → Questions - Cascade
   - Question → AnswerOptions - Cascade
   - Survey → SurveyResponses - Cascade
   - SurveyResponse → UserAnswers - Cascade

4. **Настройка свойств**:
   - UserAnswer.TextAnswer - nullable (явно)

**DbSet'ы (таблицы):**
- `Surveys` - опросы
- `Questions` - вопросы
- `AnswerOptions` - варианты ответов
- `SurveyResponses` - ответы на опросы
- `UserAnswers` - конкретные ответы на вопросы
- `SurveyTemplates` - шаблоны опросов
- `TemplateQuestions` - вопросы шаблонов
- `TemplateAnswerOptions` - варианты ответов шаблонов
- `Sections` - разделы опросов
- `Media` - медиа-элементы

---

### DbInitializer

**Расположение**: `Data/DbInitializer.cs`  
**Тип**: `static class`

**Назначение**: Инициализация базы данных при старте приложения

**Логика:**

#### Инициализация
```csharp
public static async Task Initialize(UserManager<ApplicationUser> userManager, RoleManager<IdentityRole> roleManager)
```

1. **Создание ролей**:
   - Проверка существования роли
   - Создание ролей "Administrator" и "User", если их нет

2. **Создание администратора по умолчанию**:
   - Проверка наличия администраторов
   - Если нет: создание пользователя admin@novoyahope.com
   - Назначение роли "Administrator"
   - Пароль: "SecureAdmin123!" (⚠️ следует изменить перед деплоем)

**Вызов:**
- Вызывается при старте приложения в `Program.cs`

---

## Схема взаимодействия

### Пример: Создание и сохранение опроса

```
1. Пользователь → SurveyController.Edit(null)
   └─> Создание нового Survey
       └─> Перенаправление на Edit(id)

2. Конструктор отправляет AJAX запрос
   └─> SurveyController.SaveSurvey(model)
       ├─> Валидация модели
       ├─> Обработка файлов через ImageHelper
       └─> SurveyService.SaveSurveyAsync(model, userId)
           ├─> Определение: создание или обновление
           ├─> Обновление метаданных
           ├─> Синхронизация вопросов
           ├─> Синхронизация вариантов ответов
           ├─> Синхронизация разделов
           ├─> Синхронизация медиа
           └─> ApplicationDbContext.SaveChangesAsync()
               └─> Запись в базу данных

3. Возврат JSON ответа
   └─> Обновление UI конструктора
```

### Пример: Прохождение опроса

```
1. Пользователь → PublicController.ViewSurvey(id)
   └─> Загрузка опроса из ApplicationDbContext
       └─> Отображение формы

2. Пользователь заполняет и отправляет форму
   └─> PublicController.SubmitResponse(SurveyId, form)
       ├─> Парсинг данных формы
       ├─> Проверка существования и публикации опроса
       ├─> Определение пользователя (если не анонимный)
       ├─> Создание SurveyResponse
       ├─> Обработка каждого ответа:
       │   ├─> Валидация обязательных вопросов
       │   ├─> Создание UserAnswer для текстовых
       │   └─> Создание UserAnswer для выбранных вариантов
       └─> ApplicationDbContext.SaveChangesAsync()
           └─> Сохранение всех ответов

3. Перенаправление на ThankYou
```

---

## Разделение ответственности

### Контроллеры
- ✅ Обработка HTTP запросов и ответов
- ✅ Валидация входных данных (ModelState)
- ✅ Проверка прав доступа (авторизация)
- ✅ Координация вызовов сервисов
- ✅ Формирование ViewModel для представлений
- ✅ Обработка исключений и возврат ошибок
- ❌ Бизнес-логика (делегируется сервисам)
- ❌ Прямые запросы к базе (кроме простых операций)

### Сервисы
- ✅ Бизнес-логика и правила обработки данных
- ✅ Сложные операции с данными (синхронизация, агрегация)
- ✅ Транзакции и целостность данных
- ✅ Валидация бизнес-правил
- ❌ Обработка HTTP запросов
- ❌ Формирование представлений

### Helpers
- ✅ Переиспользуемые утилиты
- ✅ Валидация данных
- ✅ Работа с файловой системой
- ✅ Форматирование данных
- ❌ Бизнес-логика
- ❌ Работа с базой данных

### ApplicationDbContext
- ✅ Конфигурация Entity Framework
- ✅ Определение связей между сущностями
- ✅ Настройка каскадных удалений
- ✅ Доступ к данным через DbSet
- ❌ Бизнес-логика

---

## Резюме классов с серверной логикой

| Класс | Назначение | Основная логика |
|-------|------------|-----------------|
| **AccountController** | Аутентификация и профили | Вход, регистрация, управление профилем, смена пароля |
| **SurveyController** | Управление опросами | Создание, редактирование, публикация, результаты, экспорт |
| **PublicController** | Публичный доступ | Просмотр опросов, отправка ответов |
| **AdminController** | Администрирование | Управление пользователями, опросами, шаблонами, статистика |
| **HomeController** | Публичные страницы | Главная страница, статичные страницы |
| **SurveyService** | Бизнес-логика опросов | Сохранение, синхронизация данных, валидация |
| **ImageHelper** | Работа с изображениями | Валидация, сохранение, удаление изображений |
| **ValidationHelper** | Валидация данных | Проверка Email, телефона, пароля, санитизация |
| **ApplicationDbContext** | Доступ к данным | Конфигурация EF, связи, каскадные удаления |
| **DbInitializer** | Инициализация БД | Создание ролей и администратора |

---

## Версия документации

- **Версия**: 1.0
- **Дата**: 2025
- **Автор**: NovoyaHope Development Team
- **Последнее обновление**: Соответствует коду на момент создания документации

